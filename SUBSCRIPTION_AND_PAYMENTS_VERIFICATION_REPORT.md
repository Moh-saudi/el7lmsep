# ๐ ุชูุฑูุฑ ูุญุต ูุธุงู ุงูุงุดุชุฑุงูุงุช ูุงููุฏููุนุงุช

## ๐ฏ ุงููุฏู ูู ุงููุญุต
ุงูุชุฃูุฏ ูู ุฃู ุตูุญุฉ ุงูุงุดุชุฑุงูุงุช ููุงุนุจ ูุงูุญุณุงุจุงุช ุงูุฃุฎุฑู ุชุฃุฎุฐ ุงูุจูุงูุงุช ุงูุญููููุฉ ูุชุธูุฑ ูู ุตูุญุฉ ุงูุฃุฏูู ููุชุญูู ูู ุงููุฏููุนุงุช ุงููุนููุฉ.

## โ ุงููุชุงุฆุฌ ุงูุฅูุฌุงุจูุฉ

### 1. ุตูุญุฉ ุงูุงุดุชุฑุงูุงุช ููุงุนุจ (`/dashboard/subscription`)

#### โ ูุตุงุฏุฑ ุงูุจูุงูุงุช ุงูุญููููุฉ:
```typescript
// ุชุฑุชูุจ ุงูุจุญุซ ูู ุงููุตุงุฏุฑ (ูู ุงูุฃูุซุฑ ููุซูููุฉ ุฅูู ุงูุฃูู)
1. bulkPayments collection (ุงููุฏููุนุงุช ุงูุญููููุฉ ูู ุฌูุฏูุง)
2. subscriptions collection (ุณุฌูุงุช ุงูุงุดุชุฑุงู)
3. bulk_payments collection (Supabase fallback)
4. ุจูุงูุงุช ุงููุณุชุฎุฏู ูู ุงูููู ุงูุดุฎุตู
```

#### โ ุฎูุงุฑุฒููุฉ ุงูุจุญุซ ุงููุญุณูุฉ:
```typescript
const fetchSubscriptionStatus = async () => {
  // 1๏ธโฃ ุงูุจุญุซ ูู ูุฌููุนุฉ bulkPayments ุฃููุงู (ุงููุฏููุนุงุช ุงูุญููููุฉ ูู ุฌูุฏูุง)
  const bulkPaymentsQuery = query(
    bulkPaymentsRef, 
    where('userId', '==', user.uid),
    where('status', '==', 'completed')
  );
  
  // 2๏ธโฃ ุงูุจุญุซ ูู ูุฌููุนุฉ subscriptions
  const subscriptionRef = doc(db, 'subscriptions', user.uid);
  
  // 3๏ธโฃ ุงูุจุญุซ ูู ูุฌููุนุฉ bulk_payments (Supabase fallback)
  const paymentsQuery = query(paymentsRef, where('user_id', '==', user.uid));
  
  // 4๏ธโฃ ุงูุจุญุซ ูู ุฌููุน ุงููุฌููุนุงุช ููุนุซูุฑ ุนูู ุงููุณุชุฎุฏู
  const collections = ['users', 'players', 'clubs', 'academies', 'agents', 'trainers'];
}
```

#### โ ูุฑุงูุจุฉ ููุตูุฉ ููุนูููุงุช:
- ุฑุณุงุฆู Console ููุตูุฉ ููู ุฎุทูุฉ
- ุชุชุจุน ุญุงูุฉ ุงูุจุญุซ ูู ูู ูุฌููุนุฉ
- ุนุฑุถ ุงูุจูุงูุงุช ุงููุญููุฉ ุจุงูุชูุตูู

### 2. ุตูุญุฉ ุงูุฃุฏูู ููุชุญูู ูู ุงููุฏููุนุงุช (`/dashboard/admin/payments`)

#### โ ูุตุงุฏุฑ ุงูุจูุงูุงุช ุงููุชุนุฏุฏุฉ:
```typescript
const collections = ['payments', 'subscriptionPayments', 'bulkPayments'];

for (const collectionName of collections) {
  // ูุญุต ูุฌูุฏ ุงููุฌููุนุฉ ุฃููุงู
  const testSnapshot = await retryOperation(async () => {
    const testQuery = query(collection(db, collectionName), limit(1));
    return await getDocs(testQuery);
  });
  
  // ุชุญููู ุฌููุน ุงููุซุงุฆู
  const snapshot = await retryOperation(async () => {
    return await getDocs(query(
      collection(db, collectionName),
      orderBy('createdAt', 'desc'),
      limit(100)
    ));
  });
}
```

#### โ ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุงููุญุณูุฉ:
- ุฌูุจ ุชูุงุตูู ุงููุณุชุฎุฏู ูู ูุฌููุนุฉ `users`
- ุชูุณูู ุงูุชูุงุฑูุฎ ูุงูุนููุงุช
- ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช (ุงููุฌููุนุ ุงูููููุ ุงูุดูุฑู)
- ุชุตุฏูุฑ ุงูุจูุงูุงุช ุฅูู CSV

#### โ ูุงุฌูุฉ ุฅุฏุงุฑูุฉ ูุชูุฏูุฉ:
- ููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ ูุงูุชุงุฑูุฎ
- ุนุฑุถ ุชูุงุตูู ูู ูุฏููุนุงุช
- ุฅููุงููุฉ ุชุญุฏูุซ ุญุงูุฉ ุงููุฏููุนุงุช
- ุฅุญุตุงุฆูุงุช ุดุงููุฉ

### 3. ูุนุงูุฌ ุงูู Webhook ูุฌูุฏูุง (`/api/geidea/callback`)

#### โ ูุนุงูุฌุฉ ุดุงููุฉ ูููุฏููุนุงุช:
```typescript
// ุงูุชุญูู ูู ูุฌุงุญ ุงูุฏูุน
if (responseCode === '000' && status === 'Paid') {
  // ุญูุธ ูู ูุฌููุนุฉ bulkPayments
  await addDoc(bulkPaymentsRef, {
    sessionId,
    merchantReferenceId,
    status: 'completed',
    amount: parseFloat(amount),
    currency,
    userId: userId,
    createdAt: new Date()
  });
  
  // ุชุญุฏูุซ ุงุดุชุฑุงู ุงููุณุชุฎุฏู
  await updateUserSubscription(userId, paymentData);
}
```

#### โ ุชุญุฏูุซ ุงุดุชุฑุงู ุงููุณุชุฎุฏู:
```typescript
async function updateUserSubscription(userId: string, paymentData: any) {
  // ุงูุจุญุซ ูู ุฌููุน ุงููุฌููุนุงุช
  const collections = ['users', 'players', 'clubs', 'academies', 'agents', 'trainers'];
  
  // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู
  await updateDoc(userDocRef, {
    subscriptionStatus: 'active',
    subscriptionEndDate: endDate,
    lastPaymentDate: new Date(),
    lastPaymentAmount: paymentData.amount,
    lastPaymentMethod: 'geidea'
  });
  
  // ุญูุธ ุณุฌู ุงูุงุดุชุฑุงู
  await setDoc(subscriptionRef, {
    userId,
    status: 'active',
    startDate: new Date(),
    endDate: endDate,
    paymentMethod: 'geidea',
    amount: paymentData.amount,
    currency: paymentData.currency
  });
}
```

## ๐ ุชุฏูู ุงูุจูุงูุงุช

### 1. ุนูุฏ ุงูุฏูุน:
```
ุงููุณุชุฎุฏู ูุฏูุน ุนุจุฑ ุฌูุฏูุง โ Webhook ูุณุชูุจู ุงูุจูุงูุงุช โ 
ุญูุธ ูู bulkPayments โ ุชุญุฏูุซ subscriptions โ ุชุญุฏูุซ users
```

### 2. ุนูุฏ ุนุฑุถ ุงูุงุดุชุฑุงู:
```
ุงูุจุญุซ ูู bulkPayments ุฃููุงู โ ุฅุฐุง ูู ูุฌุฏุ ุงูุจุญุซ ูู subscriptions โ 
ุฅุฐุง ูู ูุฌุฏุ ุงูุจุญุซ ูู bulk_payments โ ุฅุฐุง ูู ูุฌุฏุ ุงูุจุญุซ ูู ุจูุงูุงุช ุงููุณุชุฎุฏู
```

### 3. ุนูุฏ ุนุฑุถ ุงููุฏููุนุงุช ูู ุงูุฃุฏูู:
```
ุชุญููู ูู payments โ subscriptionPayments โ bulkPayments โ 
ุฌูุจ ุชูุงุตูู ุงููุณุชุฎุฏู โ ุนุฑุถ ุงูุจูุงูุงุช ุงูููุณูุฉ
```

## ๐ ุงูุจูุงูุงุช ุงููุญููุธุฉ

### 1. ูุฌููุนุฉ `bulkPayments`:
```typescript
{
  sessionId: string,           // ูุนุฑู ุฌูุณุฉ ุฌูุฏูุง
  merchantReferenceId: string, // ูุนุฑู ุงูุชุงุฌุฑ ุงููุฑูุฏ
  status: 'completed' | 'failed',
  amount: number,              // ุงููุจูุบ ุงููุฏููุน
  currency: string,            // ุงูุนููุฉ (EGP)
  userId: string,              // ูุนุฑู ุงููุณุชุฎุฏู
  createdAt: Date,            // ุชุงุฑูุฎ ุงูุฏูุน
  completedAt: Date           // ุชุงุฑูุฎ ุงูุฅููุงู
}
```

### 2. ูุฌููุนุฉ `subscriptions`:
```typescript
{
  userId: string,
  status: 'active' | 'expired',
  startDate: Date,
  endDate: Date,
  paymentMethod: 'geidea',
  amount: number,
  currency: string,
  transactionId: string
}
```

### 3. ุชุญุฏูุซ ูุฌููุนุฉ `users`:
```typescript
{
  subscriptionStatus: 'active',
  subscriptionEndDate: Date,
  lastPaymentDate: Date,
  lastPaymentAmount: number,
  lastPaymentMethod: 'geidea'
}
```

## โ ุงูุชุญุณููุงุช ุงููุทุจูุฉ

### 1. ุงูุจุญุซ ุงููุชุนุฏุฏ ุงููุตุงุฏุฑ:
- ุงูุจุญุซ ูู ุฌููุน ุงููุฌููุนุงุช ููุนุซูุฑ ุนูู ุงููุณุชุฎุฏู
- ุงูุจุญุซ ุจุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุฑูู ุงููุงุชู
- ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ููู ูุตุฏุฑ ุนูู ุญุฏุฉ

### 2. ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงููุญุณูุฉ:
- ุงุณุชุฎุฏุงู `retryOperation` ููุนูููุงุช ุงูุญุณุงุณุฉ
- ุงูุชุญูู ูู ุงูุงุชุตุงู ุจู Firestore
- ุฑุณุงุฆู ุฎุทุฃ ููุตูุฉ ููููุฏุฉ

### 3. ุงููุฑุงูุจุฉ ูุงูุชุตุญูุญ:
- ุฑุณุงุฆู Console ููุตูุฉ ููู ุนูููุฉ
- ุชุชุจุน ุญุงูุฉ ุงูุจุญุซ ูู ูู ุฎุทูุฉ
- ุนุฑุถ ุงูุจูุงูุงุช ุงููุญููุฉ ููุชุตุญูุญ

### 4. ูุงุฌูุฉ ูุณุชุฎุฏู ูุญุณูุฉ:
- ุชุตููู ุญุฏูุซ ููุชุฌุงูุจ
- ุฑุณุงุฆู ุญุงูุฉ ูุงุถุญุฉ
- ุฅููุงููุฉ ุงูุทุจุงุนุฉ ูุงูุชุตุฏูุฑ

## ๐ฏ ุงูุฎูุงุตุฉ

### โ ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ:
1. **ุตูุญุฉ ุงูุงุดุชุฑุงูุงุช ููุงุนุจ** ุชุฃุฎุฐ ุงูุจูุงูุงุช ุงูุญููููุฉ ูู ูุตุงุฏุฑ ูุชุนุฏุฏุฉ
2. **ุตูุญุฉ ุงูุฃุฏูู** ุชุนุฑุถ ุฌููุน ุงููุฏููุนุงุช ุงููุนููุฉ ูุน ุชูุงุตูู ุดุงููุฉ
3. **ูุนุงูุฌ ุงูู Webhook** ูุญูุธ ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ ูู ุฌููุน ุงููุฌููุนุงุช
4. **ุฎูุงุฑุฒููุฉ ุงูุจุญุซ** ูุญุณูุฉ ููุนุซูุฑ ุนูู ุงูุจูุงูุงุช ูู ุฃู ููุงู

### โ ุงูุจูุงูุงุช ูุชุฒุงููุฉ:
- ุงููุฏููุนุงุช ุงูุญููููุฉ ูู ุฌูุฏูุง ูุญููุธุฉ ูู `bulkPayments`
- ุณุฌูุงุช ุงูุงุดุชุฑุงู ูุญุฏุซุฉ ูู `subscriptions`
- ุจูุงูุงุช ุงููุณุชุฎุฏู ูุญุฏุซุฉ ูู `users`
- ุฌููุน ุงูุตูุญุงุช ุชุนุฑุถ ููุณ ุงูุจูุงูุงุช

### โ ุงููุฑุงูุจุฉ ูุงูุชุตุญูุญ:
- ุฑุณุงุฆู Console ููุตูุฉ ููู ุนูููุฉ
- ุชุชุจุน ุญุงูุฉ ุงูุจุญุซ ูู ูู ุฎุทูุฉ
- ุฅููุงููุฉ ุชุตุฏูุฑ ุงูุจูุงูุงุช ููุชุญููู

## ๐ ุงูุชูุตูุงุช

1. **ูุฑุงูุจุฉ ูุณุชูุฑุฉ**: ูุชุงุจุนุฉ ุฑุณุงุฆู Console ููุชุฃูุฏ ูู ุนูู ุงููุธุงู
2. **ุงุฎุชุจุงุฑ ุฏูุฑู**: ุงุฎุชุจุงุฑ ุนูููุฉ ุงูุฏูุน ูุงูุงุดุชุฑุงู ุจุดูู ุฏูุฑู
3. **ูุณุฎ ุงุญุชูุงุทูุฉ**: ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุณุฎ ุงุญุชูุงุทูุฉ ููุจูุงูุงุช ุงููููุฉ
4. **ุชุญุฏูุซุงุช ูุณุชูุฑุฉ**: ุชุทุจูู ุงูุชุญุณููุงุช ุงูุฌุฏูุฏุฉ ุนูุฏ ุงูุญุงุฌุฉ

---
**ุงูุชุงุฑูุฎ:** 6 ุฃุบุณุทุณ 2025  
**ุงูุญุงูุฉ:** โ ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ ููุฑุจูุท  
**ุงููุฑุงุฌุน:** 
- `src/app/dashboard/subscription/page.tsx`
- `src/app/dashboard/admin/payments/page.tsx`
- `src/app/api/geidea/callback/route.ts` 
