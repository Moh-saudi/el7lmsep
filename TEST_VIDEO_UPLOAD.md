# دليل اختبار رفع الفيديوهات

## نظرة عامة

تم إنشاء نظام شامل لرفع الفيديوهات باستخدام Supabase Storage بدلاً من Firebase Storage لحل مشكلة CORS. هذا الدليل يوضح كيفية اختبار النظام الجديد.

## المتطلبات

### 1. تثبيت التبعيات
```bash
npm install form-data node-fetch
```

### 2. إنشاء ملف فيديو تجريبي
قم بإنشاء ملف `test-video.mp4` في مجلد المشروع الرئيسي بحجم أقل من 100MB.

### 3. تشغيل الخادم المحلي
```bash
npm run dev
```

## الاختبارات المتاحة

### 1. اختبار رفع الفيديو الأساسي
```bash
npm run test:video:upload
```

### 2. اختبار حذف الفيديو
```bash
npm run test:video:delete
```

### 3. اختبار أنواع ملفات غير مدعومة
```bash
npm run test:video:invalid
```

### 4. اختبار ملف كبير جداً
```bash
npm run test:video:large
```

### 5. اختبار بدون معرف مستخدم
```bash
npm run test:video:no-user
```

### 6. تشغيل جميع الاختبارات
```bash
npm run test:video
```

## الاختبار اليدوي

### 1. اختبار رفع الفيديو من المتصفح

1. افتح التطبيق في المتصفح
2. اذهب إلى صفحة الفيديوهات
3. حاول رفع فيديو
4. تحقق من عدم ظهور أخطاء CORS
5. تحقق من ظهور رابط الفيديو المرفوع

### 2. اختبار حذف الفيديو

1. ارفع فيديو
2. احذف الفيديو
3. تحقق من حذفه من القائمة
4. تحقق من حذفه من Storage

### 3. اختبار الأخطاء

1. حاول رفع ملف كبير جداً (>100MB)
2. حاول رفع نوع ملف غير مدعوم
3. تحقق من ظهور رسائل خطأ واضحة

## النتائج المتوقعة

### ✅ النتائج الإيجابية

1. **رفع ناجح**: يجب أن يتم رفع الفيديو بنجاح مع الحصول على رابط صحيح
2. **حذف ناجح**: يجب أن يتم حذف الفيديو من Storage والقائمة
3. **رسائل خطأ واضحة**: يجب أن تظهر رسائل خطأ واضحة للملفات غير المدعومة

### ❌ النتائج السلبية

1. **أخطاء CORS**: لا يجب أن تظهر أخطاء CORS
2. **أخطاء الشبكة**: لا يجب أن تظهر أخطاء في الاتصال
3. **أخطاء الخادم**: لا يجب أن تظهر أخطاء 500

## استكشاف الأخطاء

### 1. مشكلة في الاتصال بـ Supabase

**الأعراض**: أخطاء في الاتصال أو رفض الطلبات
**الحل**: 
- تحقق من إعدادات Supabase في `.env.local`
- تحقق من وجود buckets مطلوبة
- تحقق من RLS policies

### 2. مشكلة في حجم الملف

**الأعراض**: رفض الملفات الكبيرة
**الحل**:
- تحقق من إعدادات `maxSize` في API route
- تحقق من إعدادات Supabase Storage

### 3. مشكلة في نوع الملف

**الأعراض**: رفض أنواع ملفات معينة
**الحل**:
- تحقق من `allowedTypes` في API route
- أضف أنواع ملفات جديدة إذا لزم الأمر

### 4. مشكلة في CORS

**الأعراض**: أخطاء CORS في المتصفح
**الحل**:
- تحقق من إعدادات CORS في `next.config.js`
- تحقق من إعدادات CORS في `middleware.js`
- تأكد من أن API route يعمل بشكل صحيح

## إعدادات Supabase المطلوبة

### 1. إنشاء Storage Buckets

```sql
-- إنشاء bucket للفيديوهات
INSERT INTO storage.buckets (id, name, public) 
VALUES ('videos', 'videos', true);

-- إنشاء bucket لفيديوهات اللاعبين
INSERT INTO storage.buckets (id, name, public) 
VALUES ('player-videos', 'player-videos', true);
```

### 2. إعداد RLS Policies

```sql
-- السماح بالقراءة العامة للفيديوهات
CREATE POLICY "Public Access" ON storage.objects
FOR SELECT USING (bucket_id = 'videos');

-- السماح بالرفع للمستخدمين المسجلين
CREATE POLICY "Authenticated users can upload" ON storage.objects
FOR INSERT WITH CHECK (bucket_id = 'videos' AND auth.role() = 'authenticated');

-- السماح بالحذف لمالك الفيديو
CREATE POLICY "Users can delete own videos" ON storage.objects
FOR DELETE USING (bucket_id = 'videos' AND auth.uid()::text = (storage.foldername(name))[1]);
```

## مراقبة الأداء

### 1. مراقبة حجم الملفات
- تحقق من متوسط حجم الفيديوهات المرفوعة
- راقب استخدام التخزين

### 2. مراقبة الأخطاء
- راقب أخطاء الرفع والحذف
- راقب أخطاء الشبكة

### 3. مراقبة الأداء
- راقب سرعة الرفع
- راقب استجابة API

## التحسينات المستقبلية

1. **ضغط الفيديوهات**: إضافة ضغط تلقائي للفيديوهات
2. **معاينات مصغرة**: إنشاء معاينات مصغرة تلقائية
3. **تحويل التنسيق**: تحويل الفيديوهات إلى تنسيقات مدعومة
4. **التخزين المؤقت**: إضافة تخزين مؤقت للفيديوهات
5. **CDN**: استخدام CDN لتسريع التحميل

## الدعم

إذا واجهت أي مشاكل، يرجى:

1. مراجعة سجلات الخادم
2. مراجعة سجلات المتصفح
3. اختبار API routes مباشرة
4. التحقق من إعدادات Supabase
5. مراجعة هذا الدليل 
