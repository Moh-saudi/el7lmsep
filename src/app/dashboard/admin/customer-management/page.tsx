'use client';

import * as React from 'react';
import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { 
  Upload, 
  Search, 
  Phone, 
  MessageSquare, 
  Users, 
  RefreshCw,
  Trash2,
  Database,
  Download,
  FileText,
  Shield
} from 'lucide-react';
import { AccountTypeProtection } from '@/hooks/useAccountTypeAuth';
import { useEmployeePermissions, PermissionGuard, PermissionsInfo } from '@/hooks/useEmployeePermissions';
import Papa from 'papaparse';
import * as XLSX from 'xlsx';
import { collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';
import { useAuth } from '@/lib/firebase/auth-provider';

interface Customer {
  id: string;
  name: string;
  phone: string;
  email?: string;
  type: 'registered' | 'potential' | 'vip';
  group: string;
  date: string;
  status: 'active' | 'inactive' | 'pending';
  country?: string;
  countryCode?: string;
  displayName?: string;
  isMyContact?: boolean;
  savedName?: string;
  groupName?: string;
  createdAt?: Date;
  updatedAt?: Date;
  lastAction?: string;
  lastActionDate?: Date;
  lastActionBy?: string;
  leadScore?: number;
  // New tracking fields
  contactStatus?: 'not_contacted' | 'contacted' | 'interested' | 'not_interested' | 'registered';
  contactHistory?: ContactRecord[];
  lastContactDate?: Date;
  contactCount?: number;
  notes?: string;
  priority?: 'low' | 'medium' | 'high';
  assignedTo?: string;
}

interface ContactRecord {
  id: string;
  type: 'call' | 'whatsapp' | 'email' | 'visit';
  date: Date;
  status: 'success' | 'no_answer' | 'busy' | 'wrong_number' | 'not_interested';
  notes?: string;
  employeeName: string;
  duration?: number; // for calls
  message?: string; // for whatsapp/email
}

export default function CustomerManagementPage() {
  const { user, userData } = useAuth();
  const { permissions, role, loading: permissionsLoading } = useEmployeePermissions();
  
  // ÿ•ÿ∂ÿßŸÅÿ© console.log ŸÑŸÑÿ™ÿµÿ≠Ÿäÿ≠
  console.log('üîç CustomerManagementPage - userData:', userData);
  console.log('üîç CustomerManagementPage - permissions:', permissions);
  console.log('üîç CustomerManagementPage - role:', role);
  console.log('üîç CustomerManagementPage - canEditCustomers:', permissions?.canEditCustomers);
  
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [filteredCustomers, setFilteredCustomers] = useState<Customer[]>([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState<'all' | 'registered' | 'potential' | 'vip'>('all');
  const [filterStatus, setFilterStatus] = useState<'all' | 'active' | 'inactive' | 'pending'>('all');
  const [isLoading, setIsLoading] = useState(true);
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [uploadMessage, setUploadMessage] = useState('');
  const [currentPage, setCurrentPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10);
  const [showMessageTemplates, setShowMessageTemplates] = useState(false);
  const [selectedTemplate, setSelectedTemplate] = useState('');
  const [showContactModal, setShowContactModal] = useState(false);
  const [selectedCustomer, setSelectedCustomer] = useState<Customer | null>(null);
  const [contactType, setContactType] = useState<'call' | 'whatsapp' | 'email' | 'visit'>('call');
  const [contactStatus, setContactStatus] = useState<'success' | 'no_answer' | 'busy' | 'wrong_number' | 'not_interested'>('success');
  const [contactNotes, setContactNotes] = useState('');
  const [filterContactStatus, setFilterContactStatus] = useState<'all' | 'not_contacted' | 'contacted' | 'interested' | 'not_interested' | 'registered'>('all');
  const [filterPriority, setFilterPriority] = useState<'all' | 'low' | 'medium' | 'high'>('all');
  
  // Editing state
  const [editingCustomer, setEditingCustomer] = useState<string | null>(null);
  const [editForm, setEditForm] = useState<Partial<Customer>>({});
  const [isSaving, setIsSaving] = useState(false);

  // Message templates
  const messageTemplates = {
    welcome: {
      title: 'ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ±ÿ≠Ÿäÿ® ÿπÿßŸÖÿ©',
      content: 'ŸÖÿ±ÿ≠ÿ®ÿßŸã! ÿ£ŸÜÿß ŸÖŸÜ ŸÖŸÜÿµÿ© ÿßŸÑÿ≠ŸÑŸÖ ŸÑÿßŸÉÿ™ÿ¥ÿßŸÅ ÿßŸÑŸÖŸàÿßŸáÿ® ÿßŸÑŸÉÿ±ŸàŸäÿ©. ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü'
    },
    parentCall: {
      title: 'ŸÜŸÖŸàÿ∞ÿ¨ ŸÖŸÉÿßŸÑŸÖÿ© ŸÖÿπ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±',
      content: `üéô ŸÜŸÖŸàÿ∞ÿ¨ ŸÖŸÉÿßŸÑŸÖÿ© ŸÖÿπ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ±

üë®‚Äçüíº ÿßŸÑŸÖŸàÿ∏ŸÅ:
ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿäÿß ŸÅŸÜÿØŸÖÿå ÿ£ŸÜÿß [ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ] ŸÖŸÜ ŸÖŸÜÿµÿ© ÿßŸÑÿ≠ŸÑŸÖ ŸÑÿßŸÉÿ™ÿ¥ÿßŸÅ ÿßŸÑŸÖŸàÿßŸáÿ® ÿßŸÑŸÉÿ±ŸàŸäÿ©. ÿ£ÿÆÿ®ÿßÿ± ÿ≠ÿ∂ÿ±ÿ™ŸÉ ÿ•ŸäŸáÿü

üë®‚Äçüë©‚Äçüë¶ ŸàŸÑŸä ÿßŸÑÿ£ŸÖÿ± (ÿ±ÿØ ÿπÿßÿØŸä).

üë®‚Äçüíº ÿßŸÑŸÖŸàÿ∏ŸÅ:
ÿ≠ÿ∂ÿ±ÿ™ŸÉ ÿπŸÜÿØŸÉ ÿßÿ®ŸÜ ÿ®ŸäŸÑÿπÿ® ŸÉŸàÿ±ÿ©ÿå ÿµÿ≠ÿü üëå
ÿ•ÿ≠ŸÜÿß ÿπÿßŸÖŸÑŸäŸÜ ŸÖŸÜÿµÿ© ÿ®ÿ™ÿ¨ŸÖÿπ ÿßŸÑÿ£ŸÉÿßÿØŸäŸÖŸäÿßÿ™ ŸàÿßŸÑÿ£ŸÜÿØŸäÿ© ŸÅŸä ŸÖŸÉÿßŸÜ Ÿàÿßÿ≠ÿØÿå ÿπŸÑÿ¥ÿßŸÜ ŸÉŸÑ ŸÑÿßÿπÿ® ŸÖŸàŸáŸàÿ® ŸäŸÇÿØÿ± Ÿäÿ™ÿ¥ÿßŸÅ ÿ£ÿ≥ÿ±ÿπ. ŸäÿπŸÜŸä ÿ®ÿØŸÑ ŸÖÿß ÿ™ÿØŸàÿ± ÿ£Ÿà ÿ™ÿ≥ÿ™ŸÜŸâ ÿµÿØŸÅÿ©ÿå ÿßÿ®ŸÜŸÉ ŸáŸäÿ®ŸÇŸâ ŸÇÿØÿßŸÖ ÿπŸäŸàŸÜ ÿßŸÑÿ£ŸÜÿØŸäÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©.

üë®‚Äçüíº ÿßŸÑŸÖŸàÿ∏ŸÅ (ÿ•ÿ∂ÿßŸÅÿ© ŸÇŸäŸÖÿ©):
ŸÉŸÖÿßŸÜ ÿ≠ÿ∂ÿ±ÿ™ŸÉ ÿ™ŸÇÿØÿ± ÿ™ÿ™ÿßÿ®ÿπ ŸÖŸÑŸÅ ÿßÿ®ŸÜŸÉÿå ŸÅŸäÿØŸäŸàŸáÿßÿ™Ÿáÿå ŸàÿßŸÑŸÖÿ®ÿßÿ±Ÿäÿßÿ™ ÿßŸÑŸÑŸä ÿ®Ÿäÿ¥ÿßÿ±ŸÉ ŸÅŸäŸáÿß. ŸàŸÑŸà ÿßÿ™ÿ≥ÿ¨ŸÑ ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿ£ŸÉÿßÿØŸäŸÖŸäÿ© ÿ£Ÿà ŸÜÿßÿØŸä ÿ®ŸäÿßÿÆÿØ ŸÅÿ±ÿµ ÿ£ŸÉÿ®ÿ± ŸÑŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑÿ®ÿ∑ŸàŸÑÿßÿ™ŸÜÿß ÿßŸÑÿ™ÿ≥ŸàŸäŸÇŸäÿ© ÿßŸÑŸÑŸä ÿ®Ÿäÿ≠ÿ∂ÿ±Ÿáÿß ŸÉÿ¥ÿßŸÅŸäŸÜ ÿ£ŸÜÿØŸäÿ©.

üë®‚Äçüíº ÿßŸÑŸÖŸàÿ∏ŸÅ (ÿØÿπŸàÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©):
ÿ•ÿ≠ŸÜÿß ÿπÿßŸÖŸÑŸäŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ÿ≥Ÿäÿ∑ Ÿàÿ≥ÿ±Ÿäÿπÿå ŸäŸÜŸÅÿπ ÿ£ÿ¥ÿ±ÿ≠ŸÑŸÉ ÿ•ÿ≤ÿßŸä ŸÜÿ≥ÿ¨ŸëŸÑ ŸÑÿßÿ®ŸÜŸÉ ÿØŸÑŸàŸÇÿ™Ÿä ÿπŸÑÿ¥ÿßŸÜ Ÿäÿ®ŸÇŸâ ŸÖÿ™ÿ¥ÿßŸÅ ŸÖŸÜ ÿßŸÑÿ£ŸÜÿØŸäÿ© ŸàÿßŸÑÿ£ŸÉÿßÿØŸäŸÖŸäÿßÿ™ÿü`
    },
    playerCall: {
      title: 'ŸÜŸÖŸàÿ∞ÿ¨ ŸÖŸÉÿßŸÑŸÖÿ© ŸÖÿπ ÿßŸÑŸÑÿßÿπÿ®',
      content: `üéô ŸÜŸÖŸàÿ∞ÿ¨ ŸÖŸÉÿßŸÑŸÖÿ© ŸÖÿπ ÿßŸÑŸÑÿßÿπÿ® (ŸÑŸà ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 16 ÿ≥ŸÜÿ© ŸÖÿ´ŸÑÿßŸã)

üë®‚Äçüíº ÿßŸÑŸÖŸàÿ∏ŸÅ:
ÿ•ÿ≤ŸäŸÉ Ÿäÿß ÿ®ÿ∑ŸÑÿå ÿ£ŸÜÿß [ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∏ŸÅ] ŸÖŸÜ ŸÖŸÜÿµÿ© ÿßŸÑÿ≠ŸÑŸÖ. ÿ≥ŸÖÿπÿ™ ÿ•ŸÜŸÉ ÿ®ÿ™ŸÑÿπÿ® ŸÉŸàÿ±ÿ©. ÿ™ŸÖÿßŸÖ ŸÉÿØŸáÿü

üë¶ ÿßŸÑŸÑÿßÿπÿ® (Ÿäÿ±ÿØ).

üë®‚Äçüíº ÿßŸÑŸÖŸàÿ∏ŸÅ:
ÿ®ÿµÿå ÿßŸÑŸÖŸÜÿµÿ© ÿ®ÿ™ÿßÿπÿ™ŸÜÿß ÿ®ÿ™ÿÆŸÑŸäŸÉ ÿ™ÿπŸÖŸÑ ÿ®ÿ±ŸàŸÅÿßŸäŸÑ ÿ≤Ÿä ÿßŸÑÿ≥Ÿäÿ±ÿ© ÿßŸÑÿ∞ÿßÿ™Ÿäÿ© ÿ®ÿ≥ ŸÉÿ±ŸàŸäÿ© ‚öΩ. ŸäÿπŸÜŸä ÿßŸÑÿ£ŸÜÿØŸäÿ© ŸàÿßŸÑÿ£ŸÉÿßÿØŸäŸÖŸäÿßÿ™ ŸäŸÇÿØÿ±Ÿàÿß Ÿäÿ¥ŸàŸÅŸàÿß ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ŸÉ ŸàŸÅŸäÿØŸäŸàŸáÿßÿ™ŸÉÿå ŸàŸÉŸÖÿßŸÜ ŸÖŸÖŸÉŸÜ ÿ™ÿ¥ÿßÿ±ŸÉ ŸÅŸä ŸÖÿßÿ™ÿ¥ÿßÿ™ Ÿàÿ®ÿ∑ŸàŸÑÿßÿ™ ÿ®ŸÜŸÜÿ∏ŸÖŸáÿß ÿπŸÑÿ¥ÿßŸÜ ÿßŸÑŸÉÿ¥ÿßŸÅŸäŸÜ ŸäÿÆÿ™ÿßÿ±Ÿàÿß ŸÑÿßÿπÿ®ŸäŸÜ ÿ¨ÿØÿßÿØ.

üë®‚Äçüíº ÿßŸÑŸÖŸàÿ∏ŸÅ (ÿØÿπŸàÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©):
ÿ™ÿ≠ÿ® ÿ£ÿ¥ÿ±ÿ≠ŸÑŸÉ ÿ•ÿ≤ÿßŸä ÿ™ÿ≥ÿ¨ŸëŸÑ ÿØŸÑŸàŸÇÿ™Ÿä Ÿàÿ™ÿ®ÿØÿ£ ÿ™ÿ≠ÿ∑ ÿ®ŸäÿßŸÜÿßÿ™ŸÉ ŸàŸÅŸäÿØŸäŸàŸáÿßÿ™ŸÉÿü`
    },
    followUp: {
      title: 'ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ™ÿßÿ®ÿπÿ©',
      content: 'ŸÖÿ±ÿ≠ÿ®ÿßŸã ŸÖÿ±ÿ© ÿ™ÿßŸÜŸäÿ©! ÿ£ÿ™ŸÖŸÜŸâ ÿ™ŸÉŸàŸÜ ÿ®ÿÆŸäÿ±. ŸáŸÑ ŸÅŸÉÿ±ÿ™ ŸÅŸä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ŸÅŸä ŸÖŸÜÿµÿ© ÿßŸÑÿ≠ŸÑŸÖÿü ŸÜÿ≠ŸÜ ŸáŸÜÿß ŸÑŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ŸÅŸä ÿ£Ÿä ÿÆÿ∑Ÿàÿ©.'
    },
    reminder: {
      title: 'ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ∞ŸÉŸäÿ±',
      content: 'ÿ™ÿ∞ŸÉŸäÿ± ŸàÿØŸàÿØ: ŸÑÿß ÿ™ŸÅŸàÿ™ ŸÅÿ±ÿµÿ© ÿßÿ®ŸÜŸÉ ŸÅŸä ÿßŸÑÿ∏ŸáŸàÿ± ÿ£ŸÖÿßŸÖ ÿßŸÑÿ£ŸÜÿØŸäÿ© ŸàÿßŸÑÿ£ŸÉÿßÿØŸäŸÖŸäÿßÿ™! ÿ≥ÿ¨ŸÑ ÿßŸÑÿ¢ŸÜ ŸÅŸä ŸÖŸÜÿµÿ© ÿßŸÑÿ≠ŸÑŸÖ.'
    }
  };

  // Format phone number function
  const formatPhoneNumber = (phone: string, country?: string, countryCode?: string): string => {
    if (!phone || typeof phone !== 'string') {
      return '';
    }
    
    // Remove all non-digit characters and spaces
    let cleanPhone = phone.replace(/[^\d]/g, '');
    cleanPhone = cleanPhone.replace(/\s/g, '');
    
    // Handle international format starting with 00
    if (cleanPhone.startsWith('00')) {
      cleanPhone = cleanPhone.substring(2);
      return '+' + cleanPhone;
    }
    
    // Get country code from parameters
    let targetCountryCode = '';
    if (countryCode) {
      targetCountryCode = countryCode.replace('+', '');
    } else if (country) {
      const countryCodes: { [key: string]: string } = {
        'Egypt': '20', 'Saudi Arabia': '966', 'UAE': '971', 'Kuwait': '965',
        'Oman': '968', 'Bahrain': '973', 'Qatar': '974', 'Jordan': '962',
        'Lebanon': '961', 'Syria': '963', 'Iraq': '964', 'Yemen': '967',
        'Sudan': '249', 'Morocco': '212', 'Algeria': '213', 'Tunisia': '216', 'Libya': '218'
      };
      targetCountryCode = countryCodes[country] || '';
    }
    
    // Special handling for Egyptian numbers (remove extra 2 after country code)
    if (targetCountryCode === '20' && cleanPhone.startsWith('202')) {
      // Remove the extra 2 after country code (202 -> 20)
      cleanPhone = '20' + cleanPhone.substring(3);
    }
    
    // Handle Egyptian numbers that start with 2 (common format: 2 0128811)
    if (targetCountryCode === '20' && cleanPhone.startsWith('2') && cleanPhone.length > 9) {
      // Remove the leading 2 and add country code
      cleanPhone = '20' + cleanPhone.substring(1);
    }
    
    // Check if phone already starts with country code
    if (targetCountryCode && cleanPhone.startsWith(targetCountryCode)) {
      // Phone already has country code, just add +
      return '+' + cleanPhone;
    }
    
    // Check if phone starts with any known country code
    const knownCountryCodes = ['20', '966', '971', '965', '968', '973', '974', '962', '961', '963', '964', '967', '249', '212', '213', '216', '218'];
    for (const code of knownCountryCodes) {
      if (cleanPhone.startsWith(code)) {
        // Phone already has a country code
        return '+' + cleanPhone;
      }
    }
    
    // Add country code if we have one and phone doesn't already have it
    if (targetCountryCode) {
      return '+' + targetCountryCode + cleanPhone;
    }
    
    // If no country code available, return as is with +
    return '+' + cleanPhone;
  };

  // Load customers from Firebase
  const loadCustomersFromFirebase = async () => {
    try {
      setIsLoading(true);
      const customersRef = collection(db, 'customers');
      const snapshot = await getDocs(customersRef);
      const customersData = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })) as Customer[];
      
      setCustomers(customersData);
      console.log(`ÿ™ŸÖ ÿ¨ŸÑÿ® ${customersData.length} ÿπŸÖŸäŸÑ ŸÖŸÜ Firebase`);
    } catch (error) {
      console.error('Error loading customers:', error);
    } finally {
      setIsLoading(false);
    }
  };

  // Process file data
  const processFileData = async (data: any[]) => {
    try {
      setUploadProgress(85);
      setUploadMessage('ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
      
      const newCustomers: Omit<Customer, 'id'>[] = data.map((row: any, index: number) => {
        const name = String(row['Contact\'s Public Display Name'] || row['Name'] || row['Name'] || `Customer ${index + 1}`);
        const phone = String(row['Phone Number'] || row['Phone'] || row['Phone'] || '');
        const email = String(row['Email'] || row['Email'] || '');
        const country = String(row['Country'] || row['Country'] || '');
        const countryCode = String(row['Country Code'] || row['Country Code'] || '');
        const displayName = String(row['Contact\'s Public Display Name'] || row['Display Name'] || name);
        const savedName = String(row['Saved Name'] || row['Saved Name'] || '');
        const groupName = String(row['Group Name'] || row['Group Name'] || '');
        const isMyContact = Boolean(row['is My Contact'] || row['Is My Contact'] || false);

        const formattedPhone = formatPhoneNumber(phone, country, countryCode);
        
        return {
          name,
          phone: formattedPhone,
          email,
          type: 'potential' as const,
          group: groupName || 'General',
          date: new Date().toISOString(),
          status: 'active' as const,
          country,
          countryCode,
          displayName,
          isMyContact,
          savedName,
          groupName,
          createdAt: new Date(),
          updatedAt: new Date()
        };
      });

      setUploadProgress(90);
      setUploadMessage(`ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ${newCustomers.length} ÿπŸÖŸäŸÑ...`);

      for (let i = 0; i < newCustomers.length; i++) {
        await addDoc(collection(db, 'customers'), newCustomers[i]);
        const progress = 90 + Math.round((i / newCustomers.length) * 5);
        setUploadProgress(progress);
        setUploadMessage(`ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÖŸäŸÑ ${i + 1} ŸÖŸÜ ${newCustomers.length}...`);
      }

      setUploadProgress(95);
      setUploadMessage('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
      
      await loadCustomersFromFirebase();
      
      setUploadProgress(100);
      setUploadMessage(`ÿ™ŸÖ ÿ±ŸÅÿπ ${newCustomers.length} ÿπŸÖŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!`);
      
      // Show success message
      setTimeout(() => {
        setIsUploading(false);
        setUploadProgress(0);
        setUploadMessage('');
        alert(`ÿ™ŸÖ ÿ±ŸÅÿπ ${newCustomers.length} ÿπŸÖŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!`);
      }, 2000);
      
    } catch (error) {
      console.error('Error processing data:', error);
      setUploadMessage('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
      setIsUploading(false);
      setUploadProgress(0);
      alert(`ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: ${error}`);
    }
  };

  // Handle file upload
  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // Reset upload state
    setIsUploading(true);
    setUploadProgress(0);
    setUploadMessage('ÿ¨ÿßÿ±Ÿä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ...');

    const reader = new FileReader();
    
    reader.onloadstart = () => {
      setUploadProgress(10);
      setUploadMessage('ÿ®ÿØÿ° ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ...');
    };

    reader.onprogress = (e) => {
      if (e.lengthComputable) {
        const progress = Math.round((e.loaded / e.total) * 50) + 10;
        setUploadProgress(progress);
        setUploadMessage(`ÿ¨ÿßÿ±Ÿä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ... ${progress}%`);
      }
    };

    reader.onload = async (e) => {
      try {
        setUploadProgress(60);
        setUploadMessage('ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
        
        const data = e.target?.result;
        if (!data) {
          throw new Error('ŸÅÿ¥ŸÑ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ');
        }

        if (file.name.endsWith('.csv')) {
          Papa.parse(data as string, {
            header: true,
            complete: (results) => {
              setUploadProgress(80);
              setUploadMessage('ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
              processFileData(results.data);
            },
            error: (error) => {
              console.error('Error reading CSV file:', error);
              setUploadMessage('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ CSV');
              setIsUploading(false);
              setUploadProgress(0);
              alert('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ŸÖŸÑŸÅ CSV');
            }
          });
        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
          const workbook = XLSX.read(data, { type: 'binary' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet);
          setUploadProgress(80);
          setUploadMessage('ÿ¨ÿßÿ±Ÿä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...');
          processFileData(jsonData);
        } else {
          throw new Error('ŸÜŸàÿπ ÿßŸÑŸÖŸÑŸÅ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ');
        }
      } catch (error) {
        console.error('Error processing file:', error);
        setUploadMessage('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ');
        setIsUploading(false);
        setUploadProgress(0);
        alert(`ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ: ${error}`);
      }
    };

    reader.onerror = () => {
      setUploadMessage('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ');
      setIsUploading(false);
      setUploadProgress(0);
      alert('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ');
    };

    if (file.name.endsWith('.csv')) {
      reader.readAsText(file);
    } else {
      reader.readAsBinaryString(file);
    }
  };

  // Remove duplicates
  const removeDuplicates = () => {
    const confirmed = confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü');
    if (!confirmed) return;
    
    const uniqueCustomers = customers.filter((customer, index, self) => 
      index === self.findIndex(c => c.phone === customer.phone)
    );
    
    if (uniqueCustomers.length < customers.length) {
      setCustomers(uniqueCustomers);
      alert(`ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ${customers.length - uniqueCustomers.length} ÿ™ŸÉÿ±ÿßÿ± ÿ®ŸÜÿ¨ÿßÿ≠`);
    } else {
      alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ™ŸÉÿ±ÿßÿ±ÿßÿ™');
    }
  };

  // Test phone number formatting
  const testPhoneFormatting = () => {
    const testCases = [
      { input: '+20 2 0128811', country: 'Egypt', expected: '+20128811' },
      { input: '2020128811', country: 'Egypt', expected: '+20128811' },
      { input: '2 0128811', country: 'Egypt', expected: '+20128811' },
      { input: '0128811', country: 'Egypt', expected: '+20128811' },
      { input: '+966 966123456', country: 'Saudi Arabia', expected: '+966123456' },
      { input: '966123456', country: 'Saudi Arabia', expected: '+966123456' },
    ];
    
    console.log('=== ÿßÿÆÿ™ÿ®ÿßÿ± ÿ™ŸÜÿ≥ŸäŸÇ ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸáŸàÿßÿ™ŸÅ ===');
    testCases.forEach((testCase, index) => {
      const result = formatPhoneNumber(testCase.input, testCase.country);
      const status = result === testCase.expected ? '‚úÖ ŸÜÿ¨ÿ≠' : '‚ùå ŸÅÿ¥ŸÑ';
      console.log(`${index + 1}. ${status} | ÿßŸÑŸÖÿØÿÆŸÑ: "${testCase.input}" | ÿßŸÑŸÜÿßÿ™ÿ¨: "${result}" | ÿßŸÑŸÖÿ™ŸàŸÇÿπ: "${testCase.expected}"`);
    });
    console.log('=== ŸÜŸáÿßŸäÿ© ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ===');
    
    alert('ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ console ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿ±ÿ§Ÿäÿ© ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±');
  };

  // Fix phone numbers in existing data
  const fixPhoneNumbers = async () => {
    const confirmed = confirm('ÿ≥Ÿäÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ÿ™ŸÜÿ≥ŸäŸÇ ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸáŸàÿßÿ™ŸÅ ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑÿßÿ° ÿßŸÑŸÖŸàÿ¨ŸàÿØŸäŸÜ. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü');
    if (!confirmed) return;

    try {
      setIsLoading(true);
      const customersRef = collection(db, 'customers');
      const snapshot = await getDocs(customersRef);
      
      let fixedCount = 0;
      for (const doc of snapshot.docs) {
        const customerData = doc.data();
        const originalPhone = customerData.phone;
        const fixedPhone = formatPhoneNumber(originalPhone, customerData.country, customerData.countryCode);
        
        if (originalPhone !== fixedPhone) {
          await updateDoc(doc.ref, { phone: fixedPhone });
          fixedCount++;
        }
      }
      
      await loadCustomersFromFirebase();
      alert(`ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ${fixedCount} ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠`);
    } catch (error) {
      console.error('Error fixing phone numbers:', error);
      alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿµŸÑÿßÿ≠ ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸáŸàÿßÿ™ŸÅ');
    } finally {
      setIsLoading(false);
    }
  };

  // Delete all data
  const deleteAllData = async () => {
    const confirmed = confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.');
    if (!confirmed) return;

    try {
      setIsLoading(true);
      const customersRef = collection(db, 'customers');
      const snapshot = await getDocs(customersRef);
      
      const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
      await Promise.all(deletePromises);
      
      setCustomers([]);
      alert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Error deleting data:', error);
      alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
    } finally {
      setIsLoading(false);
    }
  };

  // Filter customers
  const filterCustomers = () => {
    let filtered = customers.filter(customer => {
      if (searchTerm && !customer.name.toLowerCase().includes(searchTerm.toLowerCase()) &&
          !customer.phone.includes(searchTerm) && 
          !(customer.email && customer.email.toLowerCase().includes(searchTerm.toLowerCase()))) {
        return false;
      }

      if (filterType !== 'all' && customer.type !== filterType) {
        return false;
      }

      if (filterStatus !== 'all' && customer.status !== filterStatus) {
        return false;
      }

      if (filterContactStatus !== 'all' && customer.contactStatus !== filterContactStatus) {
        return false;
      }

      if (filterPriority !== 'all' && customer.priority !== filterPriority) {
        return false;
      }

      return true;
    });

    setFilteredCustomers(filtered);
  };

  // Communication functions
  const sendWhatsApp = async (phone: string, country?: string, countryCode?: string, customerId?: string) => {
    const formattedPhone = formatPhoneNumber(phone, country, countryCode);
    const message = 'ŸÖÿ±ÿ≠ÿ®ÿßŸã! ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉÿü';
    const whatsappUrl = `https://wa.me/${formattedPhone.replace('+', '')}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
    
    // Update last action if customer ID is provided
    if (customerId) {
      try {
        const customerRef = doc(db, 'customers', customerId);
        await updateDoc(customerRef, {
          lastAction: 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© Ÿàÿßÿ™ÿ≥ÿßÿ®',
          lastActionDate: new Date().toISOString(),
          lastActionBy: userData?.name || 'Unknown',
          updatedAt: new Date().toISOString()
        });
        await loadCustomersFromFirebase();
      } catch (error) {
        console.error('Error updating last action:', error);
      }
    }
  };

  const makeCall = async (phone: string, country?: string, countryCode?: string, customerId?: string) => {
    const formattedPhone = formatPhoneNumber(phone, country, countryCode);
    window.open(`tel:${formattedPhone}`, '_blank');
    
    // Update last action if customer ID is provided
    if (customerId) {
      try {
        const customerRef = doc(db, 'customers', customerId);
        await updateDoc(customerRef, {
          lastAction: 'ÿ•ÿ¨ÿ±ÿßÿ° ŸÖŸÉÿßŸÑŸÖÿ©',
          lastActionDate: new Date().toISOString(),
          lastActionBy: userData?.name || 'Unknown',
          updatedAt: new Date().toISOString()
        });
        await loadCustomersFromFirebase();
      } catch (error) {
        console.error('Error updating last action:', error);
      }
    }
  };

  const sendEmail = async (email: string, customerId?: string) => {
    if (email) {
      const subject = 'ŸÖÿ±ÿ≠ÿ®ÿßŸã ŸÖŸÜ ÿ£ŸÉÿßÿØŸäŸÖŸäÿ© ŸÉÿ±ÿ© ÿßŸÑŸÇÿØŸÖ';
      const body = 'ŸÖÿ±ÿ≠ÿ®ÿßŸã! ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉÿü';
      const mailtoUrl = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.open(mailtoUrl);
      
      // Update last action if customer ID is provided
      if (customerId) {
        try {
          const customerRef = doc(db, 'customers', customerId);
                  await updateDoc(customerRef, {
          lastAction: 'ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä',
          lastActionDate: new Date().toISOString(),
          lastActionBy: userData?.name || 'Unknown',
          updatedAt: new Date().toISOString()
        });
          await loadCustomersFromFirebase();
        } catch (error) {
          console.error('Error updating last action:', error);
        }
      }
    } else {
      alert('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ŸÑŸáÿ∞ÿß ÿßŸÑÿπŸÖŸäŸÑ');
    }
  };

  // Copy template to clipboard
  const copyTemplate = (templateKey: string) => {
    const template = messageTemplates[templateKey as keyof typeof messageTemplates];
    if (template) {
      navigator.clipboard.writeText(template.content).then(() => {
        alert(`ÿ™ŸÖ ŸÜÿ≥ÿÆ "${template.title}" ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©`);
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = template.content;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert(`ÿ™ŸÖ ŸÜÿ≥ÿÆ "${template.title}" ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©`);
      });
    }
  };

  // Contact tracking functions
  const openContactModal = (customer: Customer) => {
    setSelectedCustomer(customer);
    setShowContactModal(true);
    setContactNotes('');
  };

  const saveContactRecord = async () => {
    if (!selectedCustomer) return;

    try {
      const contactRecord: ContactRecord = {
        id: Date.now().toString(),
        type: contactType,
        date: new Date(),
        status: contactStatus,
        notes: contactNotes,
        employeeName: userData?.name || 'Unknown',
        message: contactType === 'whatsapp' || contactType === 'email' ? contactNotes : undefined
      };

      const customerRef = doc(db, 'customers', selectedCustomer.id);
      const updatedContactHistory = [...(selectedCustomer.contactHistory || []), contactRecord];
      
      await updateDoc(customerRef, {
        contactHistory: updatedContactHistory,
        lastContactDate: new Date().toISOString(),
        contactCount: (selectedCustomer.contactCount || 0) + 1,
        contactStatus: contactStatus === 'success' ? 'contacted' : 
                      contactStatus === 'not_interested' ? 'not_interested' : 'contacted',
        lastAction: `ÿ™ŸàÿßÿµŸÑ ${contactType === 'call' ? 'ŸÖŸÉÿßŸÑŸÖÿ©' : 
                              contactType === 'whatsapp' ? 'Ÿàÿßÿ™ÿ≥ÿßÿ®' : 
                              contactType === 'email' ? 'ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä' : 'ÿ≤Ÿäÿßÿ±ÿ©'} - ${contactStatus === 'success' ? 'ŸÜÿ¨ÿ≠' : 
                              contactStatus === 'no_answer' ? 'ŸÑŸÖ Ÿäÿ±ÿØ' : 
                              contactStatus === 'busy' ? 'ŸÖÿ¥ÿ∫ŸàŸÑ' : 
                              contactStatus === 'wrong_number' ? 'ÿ±ŸÇŸÖ ÿÆÿßÿ∑ÿ¶' : 'ÿ∫Ÿäÿ± ŸÖŸáÿ™ŸÖ'}`,
        lastActionDate: new Date().toISOString(),
        lastActionBy: userData?.name || 'Unknown',
        updatedAt: new Date().toISOString()
      });

      await loadCustomersFromFirebase();
      setShowContactModal(false);
      setSelectedCustomer(null);
      alert('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ŸàÿßÿµŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Error saving contact record:', error);
      alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ŸàÿßÿµŸÑ');
    }
  };

  const getContactStatusColor = (status: string) => {
    switch (status) {
      case 'not_contacted': return 'bg-gray-100 text-gray-800';
      case 'contacted': return 'bg-blue-100 text-blue-800';
      case 'interested': return 'bg-green-100 text-green-800';
      case 'not_interested': return 'bg-red-100 text-red-800';
      case 'registered': return 'bg-purple-100 text-purple-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getContactStatusText = (status: string) => {
    switch (status) {
      case 'not_contacted': return 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ';
      case 'contacted': return 'ÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ';
      case 'interested': return 'ŸÖŸáÿ™ŸÖ';
      case 'not_interested': return 'ÿ∫Ÿäÿ± ŸÖŸáÿ™ŸÖ';
      case 'registered': return 'ŸÖÿ≥ÿ¨ŸÑ';
      default: return 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
    }
  };

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'high': return 'bg-red-100 text-red-800';
      case 'medium': return 'bg-yellow-100 text-yellow-800';
      case 'low': return 'bg-green-100 text-green-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getPriorityText = (priority: string) => {
    switch (priority) {
      case 'high': return 'ÿπÿßŸÑŸäÿ©';
      case 'medium': return 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©';
      case 'low': return 'ŸÖŸÜÿÆŸÅÿ∂ÿ©';
      default: return 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
    }
  };

  // Format date and time
  const formatDateTime = (date: Date | string | undefined) => {
    if (!date) return 'ŸÑÿß ŸäŸàÿ¨ÿØ';
    
    try {
      let dateObj: Date;
      
      // Handle different date formats
      if (typeof date === 'string') {
        // If it's a Firestore timestamp string
        if (date.includes('T') && date.includes('Z')) {
          dateObj = new Date(date);
        } else if (date.includes('timestamp')) {
          // Handle Firestore timestamp object
          const timestamp = JSON.parse(date);
          dateObj = new Date(timestamp.seconds * 1000);
        } else {
          dateObj = new Date(date);
        }
      } else if (date instanceof Date) {
        dateObj = date;
      } else {
        // Handle Firestore timestamp object
        const timestamp = date as any;
        dateObj = new Date(timestamp.seconds * 1000);
      }
      
      // Check if date is valid
      if (isNaN(dateObj.getTime())) {
        return 'ÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠';
      }
      
      const now = new Date();
      const diffInHours = Math.abs(now.getTime() - dateObj.getTime()) / (1000 * 60 * 60);
      
      // If less than 24 hours, show relative time
      if (diffInHours < 24) {
        if (diffInHours < 1) {
          const diffInMinutes = Math.round(diffInHours * 60);
          return `ŸÖŸÜÿ∞ ${diffInMinutes} ÿØŸÇŸäŸÇÿ©`;
        } else {
          const hours = Math.round(diffInHours);
          return `ŸÖŸÜÿ∞ ${hours} ÿ≥ÿßÿπÿ©`;
        }
      } else {
        // Show full date and time
        return dateObj.toLocaleDateString('ar-EG', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
    } catch (error) {
      console.error('Error formatting date:', error, date);
      return 'ÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠';
    }
  };

  // Editing functions
  const startEditing = (customer: Customer) => {
    setEditingCustomer(customer.id);
    setEditForm({
      name: customer.name,
      phone: customer.phone,
      email: customer.email,
      type: customer.type,
      group: customer.group,
      status: customer.status,
      country: customer.country,
      countryCode: customer.countryCode,
      displayName: customer.displayName,
      isMyContact: customer.isMyContact,
      savedName: customer.savedName,
      groupName: customer.groupName,
      contactStatus: customer.contactStatus,
      priority: customer.priority,
      notes: customer.notes
    });
  };

  const cancelEditing = () => {
    setEditingCustomer(null);
    setEditForm({});
  };

  const saveCustomer = async (customerId: string) => {
    if (!permissions?.canEditCustomers) {
      alert('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπŸÖŸÑÿßÿ°');
      return;
    }

    setIsSaving(true);
    try {
      const customerRef = doc(db, 'customers', customerId);
      const updateData = {
        ...editForm,
        updatedAt: new Date().toISOString(),
        lastAction: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™',
        lastActionDate: new Date().toISOString(),
        lastActionBy: userData?.name || 'Unknown'
      };

      await updateDoc(customerRef, updateData);
      
      // Update local state
      setCustomers(prevCustomers => 
        prevCustomers.map(customer => 
          customer.id === customerId 
            ? { 
                ...customer, 
                ...editForm,
                updatedAt: new Date(),
                lastAction: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™',
                lastActionDate: new Date(),
                lastActionBy: userData?.name || 'Unknown'
              }
            : customer
        )
      );

      setEditingCustomer(null);
      setEditForm({});
      alert('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
    } catch (error) {
      console.error('Error saving customer:', error);
      alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™');
    } finally {
      setIsSaving(false);
    }
  };

  const handleEditChange = (field: keyof Customer, value: any) => {
    setEditForm(prev => ({
      ...prev,
      [field]: value
    }));
  };

  // Get last action info
  const getLastActionInfo = (customer: Customer) => {
    if (!customer.lastAction && !customer.lastActionDate) {
      return { text: 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ•ÿ¨ÿ±ÿßÿ°', date: null };
    }
    
    const actionText = customer.lastAction || 'ÿ•ÿ¨ÿ±ÿßÿ° ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
    const actionDate = customer.lastActionDate;
    
    return {
      text: actionText,
      date: actionDate
    };
  };

  // Calculate paginated customers
  const paginatedCustomers = filteredCustomers.slice(
    (currentPage - 1) * itemsPerPage,
    currentPage * itemsPerPage
  );

  const totalPages = Math.ceil(filteredCustomers.length / itemsPerPage);

  // Load data on component mount
  useEffect(() => {
    loadCustomersFromFirebase();
  }, []);

  // Apply filters when criteria change
  useEffect(() => {
    filterCustomers();
  }, [customers, searchTerm, filterType, filterStatus, filterContactStatus, filterPriority]);

  return (
    <AccountTypeProtection allowedTypes={['admin']}>
      <div className="container mx-auto p-6 space-y-6">
        <div className="flex justify-between items-center">
          <h1 className="text-3xl font-bold text-gray-900">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπŸÖŸÑÿßÿ°</h1>
          <div className="flex gap-2">
            <Button onClick={() => loadCustomersFromFirebase()} className="bg-blue-600 hover:bg-blue-700">
              <RefreshCw className="w-4 h-4 mr-2" />
              ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            </Button>
          </div>
        </div>

        {/* Quick Statistics */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <Card className="bg-gradient-to-r from-blue-500 to-blue-600 text-white">
            <CardHeader className="pb-2">
              <CardTitle className="text-lg">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿπŸÖŸÑÿßÿ°</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">{customers.length.toLocaleString()}</div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-r from-green-500 to-green-600 text-white">
            <CardHeader className="pb-2">
              <CardTitle className="text-lg">ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">
                {customers.filter(c => !c.contactStatus || c.contactStatus === 'not_contacted').length.toLocaleString()}
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-r from-purple-500 to-purple-600 text-white">
            <CardHeader className="pb-2">
              <CardTitle className="text-lg">ÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">
                {customers.filter(c => c.contactStatus === 'contacted' || c.contactStatus === 'interested').length.toLocaleString()}
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-r from-orange-500 to-orange-600 text-white">
            <CardHeader className="pb-2">
              <CardTitle className="text-lg">ŸÖŸáÿ™ŸÖŸàŸÜ</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-3xl font-bold">
                {customers.filter(c => c.contactStatus === 'interested').length.toLocaleString()}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Advanced Statistics */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Card className="bg-gradient-to-r from-red-500 to-red-600 text-white">
            <CardHeader className="pb-2">
              <CardTitle className="text-lg">ÿ£ŸàŸÑŸàŸäÿ© ÿπÿßŸÑŸäÿ©</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {customers.filter(c => c.priority === 'high').length.toLocaleString()}
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white">
            <CardHeader className="pb-2">
              <CardTitle className="text-lg">ŸÖÿ≥ÿ¨ŸÑŸàŸÜ</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {customers.filter(c => c.contactStatus === 'registered').length.toLocaleString()}
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-r from-gray-500 to-gray-600 text-white">
            <CardHeader className="pb-2">
              <CardTitle className="text-lg">ÿ∫Ÿäÿ± ŸÖŸáÿ™ŸÖŸàŸÜ</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold">
                {customers.filter(c => c.contactStatus === 'not_interested').length.toLocaleString()}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Data Management Buttons */}
        <div className="flex gap-2 flex-wrap">
          <Button 
            onClick={() => setShowMessageTemplates(!showMessageTemplates)} 
            className="bg-teal-600 hover:bg-teal-700"
          >
            <MessageSquare className="w-4 h-4 mr-2" />
            ŸÜŸÖÿßÿ∞ÿ¨ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
          </Button>
          
          {/* Advanced Tools - Only for authorized roles */}
          <PermissionGuard 
            requiredPermissions={['canAccessAdvancedTools']}
            fallback={
              <div className="text-sm text-gray-500 italic">
                ÿßŸÑÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑŸÖÿ¥ÿ±ŸÅŸäŸÜ ŸàÿßŸÑŸÖÿØŸäÿ±ŸäŸÜ ŸÅŸÇÿ∑
              </div>
            }
          >
            <div className="flex gap-2 flex-wrap">
              <PermissionGuard requiredPermissions={['canTestPhoneFormatting']}>
                <Button onClick={testPhoneFormatting} className="bg-indigo-600 hover:bg-indigo-700">
                  <Phone className="w-4 h-4 mr-2" />
                  ÿßÿÆÿ™ÿ®ÿßÿ± ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ
                </Button>
              </PermissionGuard>
              
              <PermissionGuard requiredPermissions={['canFixPhoneNumbers']}>
                <Button onClick={fixPhoneNumbers} className="bg-purple-600 hover:bg-purple-700">
                  <Phone className="w-4 h-4 mr-2" />
                  ÿ•ÿµŸÑÿßÿ≠ ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸáŸàÿßÿ™ŸÅ
                </Button>
              </PermissionGuard>
              
              <PermissionGuard requiredPermissions={['canRemoveDuplicates']}>
                <Button onClick={removeDuplicates} className="bg-orange-600 hover:bg-orange-700">
                  <Trash2 className="w-4 h-4 mr-2" />
                  ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™
                </Button>
              </PermissionGuard>
              
              <PermissionGuard requiredPermissions={['canDeleteAllData']}>
                <Button onClick={deleteAllData} className="bg-red-600 hover:bg-red-700">
                  <Database className="w-4 h-4 mr-2" />
                  ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                </Button>
              </PermissionGuard>
            </div>
          </PermissionGuard>
        </div>



        {/* Permissions Info - Always visible for debugging */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Shield className="w-5 h-5" />
              ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="p-4 bg-gray-50 rounded-lg">
              <h3 className="text-lg font-semibold mb-2">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</h3>
              <p className="text-sm text-gray-600 mb-4">ÿßŸÑÿØŸàÿ±: {role || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</p>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <h4 className="font-medium mb-2">ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿπŸÖŸÑÿßÿ°</h4>
                  <ul className="text-sm space-y-1">
                    <li>ÿπÿ±ÿ∂ ÿßŸÑÿπŸÖŸÑÿßÿ°: {permissions?.canViewCustomers ? '‚úÖ' : '‚ùå'}</li>
                    <li>ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿπŸÖŸÑÿßÿ°: {permissions?.canEditCustomers ? '‚úÖ' : '‚ùå'}</li>
                    <li>ÿ≠ÿ∞ŸÅ ÿßŸÑÿπŸÖŸÑÿßÿ°: {permissions?.canDeleteCustomers ? '‚úÖ' : '‚ùå'}</li>
                    <li>ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÖŸÑÿßÿ°: {permissions?.canAddCustomers ? '‚úÖ' : '‚ùå'}</li>
                  </ul>
                </div>
                
                <div>
                  <h4 className="font-medium mb-2">ÿßŸÑÿ™ŸàÿßÿµŸÑ</h4>
                  <ul className="text-sm space-y-1">
                    <li>ÿ•ÿ±ÿ≥ÿßŸÑ Ÿàÿßÿ™ÿ≥ÿßÿ®: {permissions?.canSendWhatsApp ? '‚úÖ' : '‚ùå'}</li>
                    <li>ÿ•ÿ¨ÿ±ÿßÿ° ŸÖŸÉÿßŸÑŸÖÿßÿ™: {permissions?.canMakeCalls ? '‚úÖ' : '‚ùå'}</li>
                    <li>ÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä: {permissions?.canSendEmails ? '‚úÖ' : '‚ùå'}</li>
                  </ul>
                </div>
                
                <div>
                  <h4 className="font-medium mb-2">ÿßŸÑÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©</h4>
                  <ul className="text-sm space-y-1">
                    <li>ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑÿ£ÿØŸàÿßÿ™ ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ©: {permissions?.canAccessAdvancedTools ? '‚úÖ' : '‚ùå'}</li>
                    <li>ÿßÿÆÿ™ÿ®ÿßÿ± ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ: {permissions?.canTestPhoneFormatting ? '‚úÖ' : '‚ùå'}</li>
                    <li>ÿ•ÿµŸÑÿßÿ≠ ÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸáŸàÿßÿ™ŸÅ: {permissions?.canFixPhoneNumbers ? '‚úÖ' : '‚ùå'}</li>
                    <li>ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ™ŸÉÿ±ÿßÿ±ÿßÿ™: {permissions?.canRemoveDuplicates ? '‚úÖ' : '‚ùå'}</li>
                    <li>ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™: {permissions?.canDeleteAllData ? '‚úÖ' : '‚ùå'}</li>
                  </ul>
                </div>
              </div>
              
              <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                <p className="text-sm text-yellow-800">
                  <strong>ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ŸÑÿß ÿ™ÿ±Ÿâ ÿ≤ÿ± ÿßŸÑÿ™ÿπÿØŸäŸÑÿå ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© "ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿπŸÖŸÑÿßÿ°" (canEditCustomers)
                </p>
              </div>
              
              {/* ÿ≤ÿ± ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ŸÑÿ•ÿ¨ÿ®ÿßÿ± ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ */}
              <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                <h4 className="font-medium mb-2">üîß ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠</h4>
                <div className="space-y-2">
                  <Button
                    size="sm"
                    onClick={() => {
                      console.log('üîß Force Admin Permissions');
                      console.log('üîß Current permissions:', permissions);
                      console.log('üîß Current role:', role);
                      console.log('üîß userData:', userData);
                      alert(`ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©:\nÿßŸÑÿØŸàÿ±: ${role}\nÿ™ÿπÿØŸäŸÑ ÿßŸÑÿπŸÖŸÑÿßÿ°: ${permissions?.canEditCustomers}\n\nuserData: ${JSON.stringify(userData, null, 2)}`);
                    }}
                    className="bg-blue-600 hover:bg-blue-700 text-white"
                  >
                    ÿπÿ±ÿ∂ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ™ÿµÿ≠Ÿäÿ≠
                  </Button>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Message Templates Section */}
        {showMessageTemplates && (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <MessageSquare className="w-5 h-5" />
                ŸÜŸÖÿßÿ∞ÿ¨ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ŸÑŸÑÿ¥ÿßÿ™ ÿ®Ÿàÿ™
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {Object.entries(messageTemplates).map(([key, template]) => (
                  <div key={key} className="border rounded-lg p-4 space-y-3">
                    <h3 className="font-semibold text-lg">{template.title}</h3>
                    <div className="text-sm text-gray-600 max-h-32 overflow-y-auto">
                      {template.content.length > 200 
                        ? template.content.substring(0, 200) + '...' 
                        : template.content}
                    </div>
                    <div className="flex gap-2">
                      <Button 
                        onClick={() => copyTemplate(key)}
                        size="sm"
                        className="bg-blue-600 hover:bg-blue-700"
                      >
                        ŸÜÿ≥ÿÆ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
                      </Button>
                      <Button 
                        onClick={() => setSelectedTemplate(key)}
                        size="sm"
                        variant="outline"
                      >
                        ÿπÿ±ÿ∂ ŸÉÿßŸÖŸÑ
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
              
              {/* Full Template View */}
              {selectedTemplate && (
                <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-semibold">
                      {messageTemplates[selectedTemplate as keyof typeof messageTemplates]?.title}
                    </h3>
                    <Button 
                      onClick={() => setSelectedTemplate('')}
                      size="sm"
                      variant="outline"
                    >
                      ÿ•ÿ∫ŸÑÿßŸÇ
                    </Button>
                  </div>
                  <div className="bg-white p-4 rounded border whitespace-pre-wrap text-sm">
                    {messageTemplates[selectedTemplate as keyof typeof messageTemplates]?.content}
                  </div>
                  <div className="mt-4">
                    <Button 
                      onClick={() => copyTemplate(selectedTemplate)}
                      className="bg-green-600 hover:bg-green-700"
                    >
                      ŸÜÿ≥ÿÆ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑŸÉÿßŸÖŸÑ
                    </Button>
                  </div>
                </div>
              )}
            </CardContent>
          </Card>
        )}

        {/* Filter and Search Tools */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Search className="w-5 h-5" />
              ÿßŸÑÿ®ÿ≠ÿ´ ŸàÿßŸÑŸÅŸÑÿ™ÿ±ÿ©
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
              <div>
                <label className="block text-sm font-medium mb-2">ÿßŸÑÿ®ÿ≠ÿ´</label>
                <Input
                  placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full"
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ</label>
                <select
                  value={filterContactStatus}
                  onChange={(e) => setFilterContactStatus(e.target.value as any)}
                  className="w-full p-2 border rounded-md"
                  aria-label="Contact Status"
                >
                  <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™</option>
                  <option value="not_contacted">ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ</option>
                  <option value="contacted">ÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ</option>
                  <option value="interested">ŸÖŸáÿ™ŸÖ</option>
                  <option value="not_interested">ÿ∫Ÿäÿ± ŸÖŸáÿ™ŸÖ</option>
                  <option value="registered">ŸÖÿ≥ÿ¨ŸÑ</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2">ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©</label>
                <select
                  value={filterPriority}
                  onChange={(e) => setFilterPriority(e.target.value as any)}
                  className="w-full p-2 border rounded-md"
                  aria-label="Priority"
                >
                  <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸàŸÑŸàŸäÿßÿ™</option>
                  <option value="high">ÿπÿßŸÑŸäÿ©</option>
                  <option value="medium">ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©</option>
                  <option value="low">ŸÖŸÜÿÆŸÅÿ∂ÿ©</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2">ŸÜŸàÿπ ÿßŸÑÿπŸÖŸäŸÑ</label>
                <select
                  value={filterType}
                  onChange={(e) => setFilterType(e.target.value as any)}
                  className="w-full p-2 border rounded-md"
                  aria-label="Customer Type"
                >
                  <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÜŸàÿßÿπ</option>
                  <option value="registered">ŸÖÿ≥ÿ¨ŸÑ</option>
                  <option value="potential">ŸÖÿ≠ÿ™ŸÖŸÑ</option>
                  <option value="vip">VIP</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2">ÿßŸÑÿ≠ÿßŸÑÿ©</label>
                <select
                  value={filterStatus}
                  onChange={(e) => setFilterStatus(e.target.value as any)}
                  className="w-full p-2 border rounded-md"
                  aria-label="Customer Status"
                >
                  <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ÿßŸÑÿßÿ™</option>
                  <option value="active">ŸÜÿ¥ÿ∑</option>
                  <option value="inactive">ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑</option>
                  <option value="pending">ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</option>
                </select>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Customers Table */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Users className="w-5 h-5" />
              ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿπŸÖŸÑÿßÿ° ({filteredCustomers.length})
            </CardTitle>
            <div className="text-sm text-gray-600 mt-2">
              <strong>ÿßŸÑÿ£ÿπŸÖÿØÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©:</strong> ÿßŸÑÿßÿ≥ŸÖ | ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ | ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ | ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© | ÿπÿØÿØ ÿßŸÑÿ™ŸàÿßÿµŸÑ | ÿ¢ÿÆÿ± ÿ™ŸàÿßÿµŸÑ | ÿ¢ÿÆÿ± ÿ•ÿ¨ÿ±ÿßÿ° | ÿßŸÑÿ®ŸÑÿØ | ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™
            </div>
          </CardHeader>
          <CardContent>
            {isLoading ? (
              <div className="flex items-center justify-center py-8">
                <div className="w-8 h-8 border-4 border-blue-200 rounded-full border-t-blue-600 animate-spin"></div>
                <span className="mr-2">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full border-collapse min-w-full">
                  <thead>
                    <tr className="bg-gray-50">
                      <th className="border p-3 text-right whitespace-nowrap">ÿßŸÑÿßÿ≥ŸÖ</th>
                      <th className="border p-3 text-right whitespace-nowrap">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</th>
                      <th className="border p-3 text-right whitespace-nowrap">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ</th>
                      <th className="border p-3 text-right whitespace-nowrap">ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©</th>
                      <th className="border p-3 text-right whitespace-nowrap">ÿπÿØÿØ ÿßŸÑÿ™ŸàÿßÿµŸÑ</th>
                      <th className="border p-3 text-right whitespace-nowrap">ÿ¢ÿÆÿ± ÿ™ŸàÿßÿµŸÑ</th>
                      <th className="border p-3 text-right whitespace-nowrap">ÿ¢ÿÆÿ± ÿ•ÿ¨ÿ±ÿßÿ°</th>
                      <th className="border p-3 text-right whitespace-nowrap">ÿßŸÑÿ®ŸÑÿØ</th>
                      <th className="border p-3 text-right whitespace-nowrap">ÿßŸÑÿ™ÿπÿØŸäŸÑ</th>
                      <th className="border p-3 text-right whitespace-nowrap">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                    </tr>
                  </thead>
                  <tbody>
                                         {paginatedCustomers.map(customer => (
                       <tr key={customer.id} className="hover:bg-gray-50">
                         <td className="border p-3 font-medium min-w-[150px]">
                           {editingCustomer === customer.id ? (
                             <Input
                               value={editForm.name || ''}
                               onChange={(e) => handleEditChange('name', e.target.value)}
                               className="w-full"
                               placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ"
                             />
                           ) : (
                             customer.name
                           )}
                         </td>
                                                    <td className="border p-3 font-mono text-sm min-w-[120px]">
                             {editingCustomer === customer.id ? (
                               <Input
                                 value={editForm.phone || ''}
                                 onChange={(e) => handleEditChange('phone', e.target.value)}
                                 className="w-full"
                                 placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ"
                               />
                             ) : (
                               customer.phone
                             )}
                           </td>
                         <td className="border p-3 min-w-[120px]">
                           {editingCustomer === customer.id ? (
                             <select
                               value={editForm.contactStatus || customer.contactStatus || 'not_contacted'}
                               onChange={(e) => handleEditChange('contactStatus', e.target.value)}
                               className="w-full p-1 border rounded text-sm"
                               aria-label="ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ"
                             >
                               <option value="not_contacted">ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ</option>
                               <option value="contacted">ÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ</option>
                               <option value="interested">ŸÖŸáÿ™ŸÖ</option>
                               <option value="not_interested">ÿ∫Ÿäÿ± ŸÖŸáÿ™ŸÖ</option>
                               <option value="registered">ŸÖÿ≥ÿ¨ŸÑ</option>
                             </select>
                           ) : (
                             <Badge className={getContactStatusColor(customer.contactStatus || 'not_contacted')}>
                               {getContactStatusText(customer.contactStatus || 'not_contacted')}
                             </Badge>
                           )}
                         </td>
                         <td className="border p-3 min-w-[100px]">
                           {editingCustomer === customer.id ? (
                             <select
                               value={editForm.priority || customer.priority || 'low'}
                               onChange={(e) => handleEditChange('priority', e.target.value)}
                               className="w-full p-1 border rounded text-sm"
                               aria-label="ÿßŸÑÿ£ŸàŸÑŸàŸäÿ©"
                             >
                               <option value="low">ŸÖŸÜÿÆŸÅÿ∂ÿ©</option>
                               <option value="medium">ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©</option>
                               <option value="high">ÿπÿßŸÑŸäÿ©</option>
                             </select>
                           ) : (
                             <Badge className={getPriorityColor(customer.priority || 'low')}>
                               {getPriorityText(customer.priority || 'low')}
                             </Badge>
                           )}
                         </td>
                         <td className="border p-3 text-center min-w-[100px]">
                           <span className="font-bold text-blue-600">
                             {customer.contactCount || 0}
                           </span>
                         </td>
                         <td className="border p-3 text-sm min-w-[120px]">
                           {customer.lastContactDate ? 
                             new Date(customer.lastContactDate).toLocaleDateString('ar-EG') : 
                             'ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿ™ŸàÿßÿµŸÑ'}
                         </td>
                         <td className="border p-3 text-sm min-w-[200px]">
                           <div className="space-y-1">
                             <div className="font-medium text-gray-900 truncate">
                               {getLastActionInfo(customer).text}
                             </div>
                             <div className="text-xs text-gray-500">
                               {formatDateTime(getLastActionInfo(customer).date)}
                             </div>
                           </div>
                         </td>
                         <td className="border p-3 min-w-[100px]">
                           {editingCustomer === customer.id ? (
                             <Input
                               value={editForm.country || ''}
                               onChange={(e) => handleEditChange('country', e.target.value)}
                               className="w-full"
                               placeholder="ÿßŸÑÿ®ŸÑÿØ"
                             />
                           ) : (
                             customer.country || '-'
                           )}
                         </td>
                         <td className="border p-3 min-w-[150px]">
                           {/* ÿ≤ÿ± ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸÖÿπ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ */}
                           <PermissionGuard requiredPermissions={['canEditCustomers']}>
                             {editingCustomer === customer.id ? (
                               <div className="flex gap-1">
                                 <Button
                                   size="sm"
                                   onClick={() => saveCustomer(customer.id)}
                                   disabled={isSaving}
                                   className="bg-green-600 hover:bg-green-700 text-white"
                                 >
                                   {isSaving ? 'ÿ≠ŸÅÿ∏...' : 'ÿ≠ŸÅÿ∏'}
                                 </Button>
                                 <Button
                                   size="sm"
                                   onClick={cancelEditing}
                                   variant="outline"
                                   className="border-red-300 text-red-600 hover:bg-red-50"
                                 >
                                   ÿ•ŸÑÿ∫ÿßÿ°
                                 </Button>
                               </div>
                             ) : (
                               <Button
                                 size="sm"
                                 onClick={() => startEditing(customer)}
                                 className="bg-blue-600 hover:bg-blue-700 text-white"
                               >
                                 ÿ™ÿπÿØŸäŸÑ
                               </Button>
                             )}
                           </PermissionGuard>
                           
                           {/* ÿ≤ÿ± ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ÿ®ÿØŸàŸÜ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ - ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÅŸÇÿ∑ */}
                           {!permissions?.canEditCustomers && (
                             <div className="text-center">
                               <Button
                                 size="sm"
                                 onClick={() => alert('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ. ÿßŸÑÿØŸàÿ± ÿßŸÑÿ≠ÿßŸÑŸä: ' + (role || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'))}
                                 className="bg-gray-400 hover:bg-gray-500 text-white"
                                 disabled
                               >
                                 ÿ™ÿπÿØŸäŸÑ (ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠)
                               </Button>
                               <p className="text-xs text-red-600 mt-1">ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿµŸÑÿßÿ≠Ÿäÿ©</p>
                             </div>
                           )}
                           
                           {/* ÿ≤ÿ± ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä ŸÖÿ§ŸÇÿ™ ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿπŸÖŸÑ ÿßŸÑŸÉŸàÿØ */}
                           {userData?.accountType === 'admin' && (
                             <div className="text-center mt-1">
                               <Button
                                 size="sm"
                                 onClick={() => {
                                   alert('ÿ≤ÿ± ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä - ÿ£ŸÜÿ™ admin!');
                                   startEditing(customer);
                                 }}
                                 className="bg-purple-600 hover:bg-purple-700 text-white"
                               >
                                 ÿ™ÿπÿØŸäŸÑ (ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä)
                               </Button>
                               <p className="text-xs text-purple-600 mt-1">ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸÅŸÇÿ∑</p>
                             </div>
                           )}
                         </td>
                         <td className="border p-3 min-w-[200px]">
                           <div className="flex gap-1 flex-wrap">
                             <PermissionGuard requiredPermissions={['canEditCustomers']}>
                               <Button
                                 variant="outline"
                                 size="sm"
                                 onClick={() => openContactModal(customer)}
                                 className="bg-purple-600 hover:bg-purple-700 text-white border-purple-600"
                                 title="ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ™ŸàÿßÿµŸÑ"
                               >
                                 <MessageSquare className="w-3 h-3" />
                               </Button>
                             </PermissionGuard>
                             
                             <PermissionGuard requiredPermissions={['canSendWhatsApp']}>
                               <Button
                                 variant="outline"
                                 size="sm"
                                 onClick={() => sendWhatsApp(customer.phone, customer.country, customer.countryCode, customer.id)}
                                 className="bg-green-600 hover:bg-green-700 text-white border-green-600"
                                 title="Ÿàÿßÿ™ÿ≥ÿßÿ®"
                               >
                                 <MessageSquare className="w-3 h-3" />
                               </Button>
                             </PermissionGuard>
                             
                             <PermissionGuard requiredPermissions={['canMakeCalls']}>
                               <Button
                                 variant="outline"
                                 size="sm"
                                 onClick={() => makeCall(customer.phone, customer.country, customer.countryCode, customer.id)}
                                 className="bg-blue-600 hover:bg-blue-700 text-white border-blue-600"
                                 title="ÿßÿ™ÿµÿßŸÑ"
                               >
                                 <Phone className="w-3 h-3" />
                               </Button>
                             </PermissionGuard>
                             
                             <PermissionGuard requiredPermissions={['canSendEmails']}>
                               {customer.email && (
                                 <Button
                                   variant="outline"
                                   size="sm"
                                   onClick={() => sendEmail(customer.email!, customer.id)}
                                   className="bg-gray-600 hover:bg-gray-700 text-white border-gray-600"
                                   title="ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä"
                                 >
                                   <MessageSquare className="w-3 h-3" />
                                 </Button>
                               )}
                             </PermissionGuard>
                           </div>
                         </td>
                       </tr>
                     ))}
                  </tbody>
                </table>
              </div>
            )}
          </CardContent>
        </Card>

        {/* Pagination */}
        {totalPages > 1 && (
          <div className="flex justify-center items-center gap-2">
            <Button
              variant="outline"
              onClick={() => setCurrentPage(1)}
              disabled={currentPage === 1}
            >
              ÿßŸÑÿ£ŸàŸÑŸâ
            </Button>
            <Button
              variant="outline"
              onClick={() => setCurrentPage(currentPage - 1)}
              disabled={currentPage === 1}
            >
              ÿßŸÑÿ≥ÿßÿ®ŸÇ
            </Button>
            
            <span className="px-4 py-2">
              ÿµŸÅÿ≠ÿ© {currentPage} ŸÖŸÜ {totalPages}
            </span>
            
            <Button
              variant="outline"
              onClick={() => setCurrentPage(currentPage + 1)}
              disabled={currentPage === totalPages}
            >
              ÿßŸÑÿ™ÿßŸÑŸä
            </Button>
            <Button
              variant="outline"
              onClick={() => setCurrentPage(totalPages)}
              disabled={currentPage === totalPages}
            >
              ÿßŸÑÿ£ÿÆŸäÿ±ÿ©
            </Button>
          </div>
        )}

        {/* File Upload Section */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Upload className="w-5 h-5" />
              ÿ±ŸÅÿπ ŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿπŸÖŸÑÿßÿ°
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div>
              <label className="block text-sm font-medium mb-2">ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ CSV ÿ£Ÿà Excel</label>
              <Input
                type="file"
                accept=".csv,.xlsx,.xls"
                onChange={handleFileUpload}
                className="w-full"
                disabled={isUploading}
              />
            </div>
            
            {/* Upload Progress */}
            {isUploading && (
              <div className="space-y-2">
                <div className="flex justify-between text-sm">
                  <span>{uploadMessage}</span>
                  <span>{uploadProgress}%</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                    style={{ width: `${uploadProgress}%` }}
                  ></div>
                </div>
              </div>
            )}
            
            <div className="flex gap-2">
              <Button onClick={() => {
                const csvContent = 'Country Code,Country,Contact\'s Public Display Name,Phone Number,is My Contact,Saved Name,Group Name\n+20,Egypt,Ahmed Mohamed,123456789,true,Ahmed,General Group';
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'customers_template.csv';
                a.click();
              }} className="bg-green-600 hover:bg-green-700">
                <Download className="w-4 h-4 mr-2" />
                ÿ™ÿ≠ŸÖŸäŸÑ ŸÜŸÖŸàÿ∞ÿ¨ CSV
              </Button>
              
              <Button onClick={() => {
                const csvContent = 'Country Code,Country,Contact\'s Public Display Name,Phone Number,is My Contact,Saved Name,Group Name\n+20,Egypt,Ahmed Mohamed,2 0128811,true,Ahmed,General Group\n+20,Egypt,Sara Ahmed,+20 2 0128811,true,Sara,Test Group\n+20,Egypt,Mohamed Ali,2020128811,false,Mohamed,VIP Group';
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'test_egyptian_numbers.csv';
                a.click();
              }} className="bg-blue-600 hover:bg-blue-700">
                <FileText className="w-4 h-4 mr-2" />
                ÿ™ÿ≠ŸÖŸäŸÑ ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑŸÖÿµÿ±Ÿäÿ©
              </Button>
            </div>
          </CardContent>
                 </Card>

         {/* Contact Modal */}
         {showContactModal && selectedCustomer && (
           <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
             <div className="bg-white rounded-lg p-6 w-full max-w-md mx-4">
               <h2 className="text-xl font-bold mb-4">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ™ŸàÿßÿµŸÑ ŸÖÿπ {selectedCustomer.name}</h2>
               
               <div className="space-y-4">
                 <div>
                   <label className="block text-sm font-medium mb-2">ŸÜŸàÿπ ÿßŸÑÿ™ŸàÿßÿµŸÑ</label>
                   <select
                     value={contactType}
                     onChange={(e) => setContactType(e.target.value as any)}
                     className="w-full p-2 border rounded-md"
                     aria-label="Contact Type"
                   >
                     <option value="call">ŸÖŸÉÿßŸÑŸÖÿ©</option>
                     <option value="whatsapp">Ÿàÿßÿ™ÿ≥ÿßÿ®</option>
                     <option value="email">ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</option>
                     <option value="visit">ÿ≤Ÿäÿßÿ±ÿ©</option>
                   </select>
                 </div>
                 
                 <div>
                   <label className="block text-sm font-medium mb-2">ÿ≠ÿßŸÑÿ© ÿßŸÑÿ™ŸàÿßÿµŸÑ</label>
                   <select
                     value={contactStatus}
                     onChange={(e) => setContactStatus(e.target.value as any)}
                     className="w-full p-2 border rounded-md"
                     aria-label="Contact Status"
                   >
                     <option value="success">ŸÜÿ¨ÿ≠</option>
                     <option value="no_answer">ŸÑŸÖ Ÿäÿ±ÿØ</option>
                     <option value="busy">ŸÖÿ¥ÿ∫ŸàŸÑ</option>
                     <option value="wrong_number">ÿ±ŸÇŸÖ ÿÆÿßÿ∑ÿ¶</option>
                     <option value="not_interested">ÿ∫Ÿäÿ± ŸÖŸáÿ™ŸÖ</option>
                   </select>
                 </div>
                 
                 <div>
                   <label className="block text-sm font-medium mb-2">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                   <textarea
                     value={contactNotes}
                     onChange={(e) => setContactNotes(e.target.value)}
                     className="w-full p-2 border rounded-md h-20"
                     placeholder="ÿßŸÉÿ™ÿ® ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ŸÉ ŸáŸÜÿß..."
                   />
                 </div>
               </div>
               
               <div className="flex gap-2 mt-6">
                 <Button
                   onClick={saveContactRecord}
                   className="bg-blue-600 hover:bg-blue-700 flex-1"
                 >
                   ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ŸàÿßÿµŸÑ
                 </Button>
                 <Button
                   onClick={() => setShowContactModal(false)}
                   variant="outline"
                   className="flex-1"
                 >
                   ÿ•ŸÑÿ∫ÿßÿ°
                 </Button>
               </div>
             </div>
           </div>
         )}
       </div>
     </AccountTypeProtection>
   );
 }
