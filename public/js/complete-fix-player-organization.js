// ?????? ??????? ?????? ???? ?????? ??? ???? ????? ????? ?????
console.log(' ?????? ??????? ?????? - ?????? ????????');

window.executeCompleteFix = async function() {
  console.log(' ??? ??????? ?????? ????? ??? ????...');
  
  try {
    // ??? Firebase
    if (typeof firebase === 'undefined') {
      throw new Error('Firebase ??? ????');
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    if (!auth.currentUser) {
      throw new Error('???? ????? ?????? ?????');
    }
    
    console.log(' Firebase ????');
    console.log(' ???????? ?????:', auth.currentUser.uid);
    
    // ???????? ?????????
    const playerId = 'hChYVnu04cXe3KK8JJQu';
    const clubId = 'Nwr78w2YdYQhsKqHzPlCPGwGN2B3';
    const clubName = '???? ????? ?????';
    
    console.log(' ??????:', playerId);
    console.log(' ??????:', clubId);
    
    // ??? ???????? ???????
    const playerDoc = await db.collection('players').doc(playerId).get();
    if (!playerDoc.exists) {
      throw new Error('?????? ??? ?????');
    }
    
    const playerData = playerDoc.data();
    console.log(' ?????? ?????:', playerData.full_name);
    
    // ????? ?????? ???????
    const updateData = {
      club_id: clubId,
      clubId: clubId,
      current_club: clubName,
      updated_at: firebase.firestore.FieldValue.serverTimestamp(),
      fixed_club_link: true,
      fixed_at: new Date().toISOString(),
      fix_version: '2.0'
    };
    
    // ????? ?? ????????
    const confirmMessage = '????? ??? ?????? ' + playerData.full_name + ' ?? ' + clubName + '. ?? ???? ?????????';
    
    if (!confirm(confirmMessage)) {
      console.log(' ?? ????? ???????');
      return;
    }
    
    // ????? ???????
    console.log(' ????? ???????...');
    
    try {
      await db.collection('players').doc(playerId).update(updateData);
      console.log(' ?? ??????? ?????');
    } catch (updateError) {
      if (updateError.code === 'permission-denied') {
        console.log(' ??? ?? ???????? - ?????? ???? ??????...');
        await db.collection('players').doc(playerId).set(updateData, { merge: true });
        console.log(' ?? ??????? ???????? ???????');
      } else {
        throw updateError;
      }
    }
    
    // ?????? ?? ???????
    const updatedDoc = await db.collection('players').doc(playerId).get();
    const updatedData = updatedDoc.data();
    
    console.log(' ??????? ????????:');
    console.log('    club_id:', updatedData.club_id);
    console.log('    clubId:', updatedData.clubId);
    console.log('    current_club:', updatedData.current_club);
    
    alert(' ?? ????? ??? ?????? ??????? ?????!\n\n???? ????? ????? ?????? ???? 3 ?????...');
    
    setTimeout(() => {
      window.location.reload();
    }, 3000);
    
  } catch (error) {
    console.error(' ??? ?? ???????:', error);
    alert(' ??? ???????: ' + error.message);
  }
};

window.quickCheck = async function() {
  try {
    const db = firebase.firestore();
    const playerId = 'hChYVnu04cXe3KK8JJQu';
    
    const doc = await db.collection('players').doc(playerId).get();
    const data = doc.data();
    
    console.log(' ?????? ???????:');
    console.log('   - ?????:', data.full_name);
    console.log('   - club_id:', data.club_id || ' ??? ?????');
    console.log('   - clubId:', data.clubId || ' ??? ?????');
    console.log('   - current_club:', data.current_club || '??? ????');
    
    if (!data.club_id && !data.clubId) {
      console.log(' ?????? ????? ??? ?????');
    } else {
      console.log(' ?????? ????? ????');
    }
    
  } catch (error) {
    console.error(' ??? ?? ?????:', error);
  }
};

console.log(' ?????? ??????? ?????? ????!');
console.log(' ??????? ???????:');
console.log('executeCompleteFix() - ????? ???????');
console.log('quickCheck() - ??? ????');
console.log(' ?????: executeCompleteFix()');

setTimeout(() => {
  quickCheck();
}, 1000);
