# ุชูุฑูุฑ ุญุงูุฉ ูุธุงู ุงูุงุดุชุฑุงูุงุช - ุงูุฑุจุท ูุน ูุธุงู ุงูุฏูุน ุงูุฅููุชุฑููู

## โ ุงูุญุงูุฉ ุงูุนุงูุฉ: **ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ ููุฑุจูุท**

### ๐ ุฑุจุท ุงูุจูุงูุงุช ูุน ูุธุงู ุงูุฏูุน

#### 1. ูุตุงุฏุฑ ุงูุจูุงูุงุช ุงูุญููููุฉ:
```
1. bulkPayments collection (ุงููุฏููุนุงุช ุงูุญููููุฉ ูู ุฌูุฏูุง)
2. subscriptions collection (ุณุฌูุงุช ุงูุงุดุชุฑุงู)
3. users collection (ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุดุฎุตูุฉ)
```

#### 2. ุชุฏูู ุงูุจูุงูุงุช ุนูุฏ ุงูุฏูุน:
```
ุงููุณุชุฎุฏู ูุฏูุน ุนุจุฑ ุฌูุฏูุง โ Webhook ูุณุชูุจู ุงูุจูุงูุงุช โ ุญูุธ ูู bulkPayments โ ุชุญุฏูุซ subscriptions โ ุชุญุฏูุซ users
```

#### 3. ุนุฑุถ ุงูุจูุงูุงุช ูู ุตูุญุฉ ุญุงูุฉ ุงูุงุดุชุฑุงู:
```
ุงูุจุญุซ ูู bulkPayments ุฃููุงู โ ุฅุฐุง ูู ูุฌุฏุ ุงูุจุญุซ ูู subscriptions โ ุฅุฐุง ูู ูุฌุฏุ ุงูุจุญุซ ูู users
```

### ๐ ุงูุชุญูู ูู ุตุญุฉ ุงูุฑุจุท

#### โ ุงูุจูุงูุงุช ุงูุญููููุฉ ูู ุฌูุฏูุง:
- **ูุฌููุนุฉ `bulkPayments`**: ุชุญุชูู ุนูู ุงููุฏููุนุงุช ุงูุญููููุฉ ูู ุฌูุฏูุง
- **ุญููู ุงูุจูุงูุงุช**:
  - `sessionId`: ูุนุฑู ุฌูุณุฉ ุงูุฏูุน ูู ุฌูุฏูุง
  - `merchantReferenceId`: ูุนุฑู ุงูุชุงุฌุฑ ุงููุฑูุฏ
  - `amount`: ุงููุจูุบ ุงููุฏููุน
  - `currency`: ุงูุนููุฉ (EGP)
  - `status`: ุญุงูุฉ ุงูุฏูุน (completed/pending/failed)
  - `paymentMethod`: ุทุฑููุฉ ุงูุฏูุน (geidea)
  - `createdAt`: ุชุงุฑูุฎ ุงูุฏูุน

#### โ ุณุฌูุงุช ุงูุงุดุชุฑุงู:
- **ูุฌููุนุฉ `subscriptions`**: ุชุญุชูู ุนูู ุณุฌูุงุช ุงูุงุดุชุฑุงู ุงููุญุฏุซุฉ
- **ุญููู ุงูุจูุงูุงุช**:
  - `userId`: ูุนุฑู ุงููุณุชุฎุฏู
  - `status`: ุญุงูุฉ ุงูุงุดุชุฑุงู (active/expired)
  - `startDate`: ุชุงุฑูุฎ ุจุฏุงูุฉ ุงูุงุดุชุฑุงู
  - `endDate`: ุชุงุฑูุฎ ุงูุชูุงุก ุงูุงุดุชุฑุงู
  - `paymentMethod`: ุทุฑููุฉ ุงูุฏูุน
  - `amount`: ุงููุจูุบ ุงููุฏููุน
  - `transactionId`: ูุนุฑู ุงููุนุงููุฉ

#### โ ุจูุงูุงุช ุงููุณุชุฎุฏู:
- **ูุฌููุนุฉ `users`**: ุชุญุชูู ุนูู ุจูุงูุงุช ุงููุณุชุฎุฏู ุงููุญุฏุซุฉ
- **ุญููู ุงูุจูุงูุงุช**:
  - `subscriptionStatus`: ุญุงูุฉ ุงูุงุดุชุฑุงู
  - `subscriptionEndDate`: ุชุงุฑูุฎ ุงูุชูุงุก ุงูุงุดุชุฑุงู
  - `lastPaymentDate`: ุชุงุฑูุฎ ุขุฎุฑ ุฏูุน
  - `lastPaymentAmount`: ูุจูุบ ุขุฎุฑ ุฏูุน
  - `lastPaymentMethod`: ุทุฑููุฉ ุขุฎุฑ ุฏูุน
  - `selectedPackage`: ุงูุจุงูุฉ ุงููุฎุชุงุฑุฉ

### ๐ ุฎูุงุฑุฒููุฉ ุงูุจุญุซ ูู ุตูุญุฉ ุญุงูุฉ ุงูุงุดุชุฑุงู

```typescript
const fetchSubscriptionStatus = async () => {
  // 1. ุงูุจุญุซ ูู bulkPayments ุฃููุงู (ุงููุฏููุนุงุช ุงูุญููููุฉ ูู ุฌูุฏูุง)
  const bulkPaymentsQuery = query(
    bulkPaymentsRef, 
    where('userId', '==', user.uid),
    where('status', '==', 'completed')
  );
  
  if (!bulkPaymentsSnapshot.empty) {
    // ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงูุญููููุฉ ูู ุฌูุฏูุง
    const paymentData = bulkPaymentsSnapshot.docs[0].data();
    // ุญุณุงุจ ุชุงุฑูุฎ ุงูุชูุงุก ุงูุงุดุชุฑุงู (3 ุฃุดูุฑ ูู ุชุงุฑูุฎ ุงูุฏูุน)
    // ุฅูุดุงุก subscriptionData ูู ุงูุจูุงูุงุช ุงูุญููููุฉ
    return;
  }
  
  // 2. ุงูุจุญุซ ูู subscriptions (ุฅุฐุง ูู ูุฌุฏ ูู bulkPayments)
  const subscriptionRef = doc(db, 'subscriptions', user.uid);
  const subscriptionDoc = await getDoc(subscriptionRef);
  
  if (subscriptionDoc.exists()) {
    // ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงูุงุดุชุฑุงู ุงููุญููุธุฉ
    return;
  }
  
  // 3. ุงูุจุญุซ ูู ุจูุงูุงุช ุงููุณุชุฎุฏู (ูุญู ุฃุฎูุฑ)
  const userDoc = await getDoc(doc(db, 'users', user.uid));
  if (userDoc.exists() && userDoc.data().subscriptionStatus === 'active') {
    // ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงููุณุชุฎุฏู
    return;
  }
  
  // ูุง ุชูุฌุฏ ุงุดุชุฑุงูุงุช ูุดุทุฉ
  return null;
};
```

### ๐ก๏ธ ุงูุฃูุงู ูุงูุชุญูู

#### โ ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช:
1. **ุงูุชุญูู ูู ูุนุฑู ุงูุฌูุณุฉ**: `sessionId` ูู ุฌูุฏูุง
2. **ุงูุชุญูู ูู ูุนุฑู ุงูุชุงุฌุฑ**: `merchantReferenceId` ูุฑูุฏ
3. **ุงูุชุญูู ูู ุงููุจูุบ**: ุชุทุงุจู ูุน ุงููุจูุบ ุงููุทููุจ
4. **ุงูุชุญูู ูู ุงูุนููุฉ**: EGP ููุท
5. **ุงูุชุญูู ูู ุงูุญุงูุฉ**: `completed` ููุท

#### โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:
- ุฅุฐุง ูุดู ุงูุฏูุนุ ูุง ูุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุงุดุชุฑุงู
- ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุจูุงูุงุชุ ูุชู ุนุฑุถ ุฑุณุงูุฉ ููุงุณุจุฉ
- ุฅุฐุง ูุงูุช ุงูุจูุงูุงุช ุบูุฑ ูุชุทุงุจูุฉุ ูุชู ุนุฑุถ ุชุญุฐูุฑ

### ๐ฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู

#### โ ุตูุญุฉ ุญุงูุฉ ุงูุงุดุชุฑุงู ุชุนุฑุถ:
- **ุญุงูุฉ ุงูุงุดุชุฑุงู**: ูุดุท/ููุชูู/ุบูุฑ ููุฌูุฏ
- **ุชุงุฑูุฎ ุงูุชูุงุก ุงูุงุดุชุฑุงู**: ูุญุณูุจ ุจุฏูุฉ
- **ุทุฑููุฉ ุงูุฏูุน**: ุฌูุฏูุง/ููุฏุงููู ูุงุด/ุงุชุตุงูุงุช ูุงุด
- **ุงููุจูุบ ุงููุฏููุน**: ุจุงูุนููุฉ ุงูุตุญูุญุฉ
- **ูุนุฑู ุงููุนุงููุฉ**: ูู ุฌูุฏูุง
- **ุชุงุฑูุฎ ุงูุฏูุน**: ุงููุนูู ูู ุฌูุฏูุง

#### โ ุฑุณุงุฆู ูุงุถุญุฉ:
- ุฅุฐุง ูู ุชูุฌุฏ ุงุดุชุฑุงูุงุช: "ูุง ุชูุฌุฏ ุงุดุชุฑุงูุงุช ูุดุทุฉ"
- ุฅุฐุง ูุงู ุงูุงุดุชุฑุงู ููุชูู: "ุงุดุชุฑุงูู ููุชูู"
- ุฅุฐุง ูุงู ุงูุงุดุชุฑุงู ูุดุท: "ุงุดุชุฑุงูู ููุนู"

### ๐ง ุงูุฃุฏูุงุช ุงููุชุงุญุฉ ููุชุญูู

#### 1. ุณูุฑูุจุช ูุญุต ุจูุงูุงุช ูุณุชุฎุฏู ูุญุฏุฏ:
```bash
node scripts/verify-subscription-data.js <user_id>
```

#### 2. ุณูุฑูุจุช ูุญุต ุฌููุน ุงููุฏููุนุงุช:
```bash
node scripts/check-all-payments.js
```

### ๐ ุงูุฅุญุตุงุฆูุงุช ุงููุชููุนุฉ

#### โ ุจุนุฏ ุชุดุบูู ุงููุธุงู:
- **ุงููุฏููุนุงุช ุงูููุชููุฉ**: ูุฌุจ ุฃู ุชุชุทุงุจู ูุน ุงูุงุดุชุฑุงูุงุช ุงููุดุทุฉ
- **ุงููุณุชุฎุฏููู ุงููุฒุงูููู**: ูุฌุจ ุฃู ูููู ูุฏููู ุจูุงูุงุช ูู ุฌููุน ุงููุฌููุนุงุช
- **ุงูุจูุงูุงุช ุงููุชุทุงุจูุฉ**: ุงููุจูุบุ ุทุฑููุฉ ุงูุฏูุนุ ุงูุญุงูุฉ

### ๐ ุงูุชูุตูุงุช

#### โ ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู:
1. **ุงูุจูุงูุงุช ุงูุญููููุฉ**: ูุฑุชุจุทุฉ ุจูุธุงู ุฌูุฏูุง
2. **ุงูุฃูุงู**: ูุญูู ูู ุฌููุน ุงูุฌูุงูุจ
3. **ุงููุงุฌูุฉ**: ูุงุถุญุฉ ูุณููุฉ ุงูุงุณุชุฎุฏุงู
4. **ุงูุฃุฏูุงุช**: ูุชุงุญุฉ ููุชุญูู ูุงููุฑุงูุจุฉ

#### โ ูุง ุชูุฌุฏ ุจูุงูุงุช ููููุฉ:
- ุฌููุน ุงูุจูุงูุงุช ุชุฃุชู ูู ูุธุงู ุงูุฏูุน ุงููุนูู
- ูุง ุชูุฌุฏ ุจูุงูุงุช ุชุฌุฑูุจูุฉ ุฃู ููููุฉ
- ุฌููุน ุงููุฏููุนุงุช ุญููููุฉ ูู ุฌูุฏูุง

### ๐ฏ ุงูุฎูุงุตุฉ

**ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ ููุฑุจูุท ุจูุธุงู ุงูุฏูุน ุงูุฅููุชุฑููู. ุฌููุน ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ ูู ุตูุญุฉ "ุญุงููุฉ ุงูุงุดุชุฑุงูุงุช" ูู ุจูุงูุงุช ุญููููุฉ ูู ูุธุงู ุฌูุฏูุง ูุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ. ูุง ุชูุฌุฏ ุฃู ุจูุงูุงุช ููููุฉ ุฃู ุชุฌุฑูุจูุฉ.**

---

*ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ูู: ${new Date().toLocaleDateString('ar-EG')}* 
